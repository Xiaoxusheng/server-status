<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨ä¸‹è½½ - æœåŠ¡å™¨æ–‡ä»¶ä¸‹è½½</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --primary-color: #4a6ee0;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --border-color: #dee2e6;
            --table-header-bg: #e9ecef;
            --table-row-even: #f8f9fa;
            --table-row-hover: #ececec;
            --debug-bg: #f8f9fa;
            --debug-text: #212529;
            --debug-border: #dee2e6;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #e9ecef;
            --card-bg: #1e1e1e;
            --primary-color: #6c8dfa;
            --secondary-color: #a0aec0;
            --success-color: #48bb78;
            --warning-color: #ecc94b;
            --danger-color: #f56565;
            --border-color: #2d3748;
            --table-header-bg: #2d3748;
            --table-row-even: #2a2a2a;
            --table-row-hover: #2d2d2d;
            --debug-bg: #2d3748;
            --debug-text: #e9ecef;
            --debug-border: #4a5568;
        }
        * {
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .header p {
            color: var(--secondary-color);
            font-size: 16px;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: var(--primary-color);
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 110, 224, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-color);
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-danger {
            background: var(--danger-color);
        }

        .btn:disabled {
            background: var(--secondary-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:disabled:hover {
            filter: none;
            transform: none;
            box-shadow: none;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .card-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 110, 224, 0.1);
        }

        .form-input.error {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.1);
        }

        .token-display {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .token-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .token-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            color: var(--secondary-color);
            margin-bottom: 4px;
        }

        .info-value {
            font-weight: 500;
            color: var(--text-color);
        }

        .tokens-list {
            margin-top: 20px;
        }

        .token-item {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .token-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(74, 110, 224, 0.1);
        }

        .token-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .token-id {
            font-weight: 600;
            color: var(--primary-color);
            font-family: 'Courier New', monospace;
        }

        .token-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
        }

        .status-expired {
            background: rgba(108, 117, 125, 0.1);
            color: var(--secondary-color);
        }

        .status-revoked {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
        }

        .token-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }

        .usage-bar {
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .usage-progress {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s;
        }

        .usage-warning {
            background: var(--warning-color);
        }

        .usage-danger {
            background: var(--danger-color);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--secondary-color);
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }

        .alert-error {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }

        .alert-info {
            background: rgba(13, 110, 253, 0.1);
            border: 1px solid rgba(13, 110, 253, 0.2);
            color: var(--primary-color);
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.2);
            color: var(--warning-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .user-details {
            flex: 1;
        }

        .username {
            font-weight: 500;
            font-size: 16px;
        }

        .user-role {
            font-size: 14px;
            color: var(--secondary-color);
        }

        .logout-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            filter: brightness(1.1);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--secondary-color);
            padding: 20px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 2px solid var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* ä¿®å¤è°ƒè¯•é¢æ¿æ ·å¼ */
        /* ä¿®å¤è°ƒè¯•é¢æ¿æ ·å¼ */
        .debug-panel {
            background: var(--debug-bg);
            border: 1px solid var(--debug-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            color: var(--debug-text);
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            color: var(--debug-text);
        }

        .debug-toggle {
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .debug-toggle:hover {
            filter: brightness(1.1);
        }

        #debugContent {
            color: var(--debug-text);
            line-height: 1.4;
        }

        #debugContent div {
            margin-bottom: 4px;
            padding: 2px 0;
            /* ç§»é™¤äº†åˆ†å‰²çº¿ */
        }

        /* ä¸‹è½½è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-title {
            font-weight: 500;
            color: var(--primary-color);
        }

        .progress-percent {
            font-weight: 600;
            color: var(--primary-color);
        }

        .progress-bar-container {
            height: 10px;
            background: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            border-radius: 5px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--secondary-color);
        }

        .progress-speed {
            font-family: 'Courier New', monospace;
        }

        .progress-time {
            font-family: 'Courier New', monospace;
        }

        .download-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .quick-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-link-btn {
            padding: 6px 12px;
            font-size: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-link-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .file-preview {
            margin-top: 15px;
            padding: 12px;
            background: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .preview-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .preview-icon {
            font-size: 24px;
        }

        .preview-details {
            flex: 1;
        }

        .preview-filename {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .preview-size {
            font-size: 12px;
            color: var(--secondary-color);
        }

        .auto-fill-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            color: var(--primary-color);
        }

        .token-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .clipboard-btn {
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 12px;
        }

        .error-hint {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .download-error-details {
            margin-top: 15px;
            padding: 12px;
            background: rgba(220, 53, 69, 0.05);
            border: 1px solid rgba(220, 53, 69, 0.2);
            border-radius: 6px;
            font-size: 13px;
        }

        .error-solution {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 6px;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .nav-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .token-details {
                grid-template-columns: 1fr;
            }

            .token-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .token-actions {
                justify-content: flex-start;
                width: 100%;
            }

            .quick-links {
                justify-content: center;
            }

            .progress-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .progress-details {
                flex-direction: column;
                gap: 5px;
            }

            .token-input-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body data-theme="light">
<div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <h1>ğŸ” å®‰å…¨æ–‡ä»¶ä¸‹è½½</h1>
        <p>ä½¿ç”¨ä¸‹è½½ä»¤ç‰Œå®‰å…¨åœ°è®¿é—®æœåŠ¡å™¨æ–‡ä»¶èµ„æº</p>
    </div>

    <!-- è°ƒè¯•é¢æ¿ -->
    <div class="debug-panel" id="debugPanel" style="display: none;">
        <div class="debug-header">
            <strong>è°ƒè¯•ä¿¡æ¯</strong>
            <button class="debug-toggle" onclick="toggleDebug()">éšè—è°ƒè¯•</button>
        </div>
        <div id="debugContent"></div>
    </div>

    <!-- å¯¼èˆªæŒ‰é’® -->
    <div class="nav-buttons">
        <button class="btn" onclick="window.location.href='index.html'">
            ğŸ“Š è¿”å›ç›‘æ§é¢æ¿
        </button>
        <button class="btn btn-secondary" onclick="toggleTheme()">
            ğŸŒ™ åˆ‡æ¢ä¸»é¢˜
        </button>
        <button class="btn" onclick="toggleDebug()">
            ğŸ› æ˜¾ç¤ºè°ƒè¯•
        </button>
    </div>

    <!-- è®¤è¯çŠ¶æ€æ˜¾ç¤º -->
    <div id="authStatusCard" class="card">
        <div class="card-title">
            <span>ğŸ” è®¤è¯çŠ¶æ€</span>
        </div>
        <div id="authStatus">
            <div class="loading">
                <div class="spinner"></div>
                <span>æ£€æŸ¥è®¤è¯çŠ¶æ€...</span>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <div class="user-info" id="userInfo" style="display: none;">
        <div class="user-avatar" id="userAvatar">U</div>
        <div class="user-details">
            <div class="username" id="usernameDisplay">ç”¨æˆ·</div>
            <div class="user-role" id="userRole">ç”¨æˆ·</div>
        </div>
        <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>

    <!-- æˆåŠŸ/é”™è¯¯æç¤º -->
    <div class="alert alert-success" id="successAlert" style="display: none;"></div>
    <div class="alert alert-error" id="errorAlert" style="display: none;"></div>
    <div class="alert alert-info" id="infoAlert" style="display: none;"></div>
    <div class="alert alert-warning" id="warningAlert" style="display: none;"></div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div id="mainContent" style="display: none;">
        <!-- ç”Ÿæˆæ–°ä»¤ç‰Œå¡ç‰‡ -->
        <div class="card">
            <div class="card-title">
                <span>ğŸ”‘ ç”Ÿæˆæ–°ä¸‹è½½ä»¤ç‰Œ</span>
            </div>
            <div class="form-group">
                <label class="form-label" for="tokenDescription">ä»¤ç‰Œæè¿°ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="tokenDescription" class="form-input"
                       placeholder="ä¾‹å¦‚ï¼šä¸´æ—¶ä¸‹è½½ä»¤ç‰Œã€é¡¹ç›®æ–‡ä»¶ä¸‹è½½ç­‰">
            </div>
            <button class="btn btn-success" onclick="generateToken()" id="generateBtn">
                ğŸ« ç”Ÿæˆä¸‹è½½ä»¤ç‰Œ
            </button>

            <!-- æ–°ä»¤ç‰Œæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="newTokenSection" style="display: none;">
                <div class="token-display">
                    <strong>æ‚¨çš„ä¸‹è½½ä»¤ç‰Œä¿¡æ¯ï¼š</strong>
                    <div class="token-info">
                        <div class="info-item">
                            <span class="info-label">ä»¤ç‰ŒID</span>
                            <span class="info-value" id="displayTokenId"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ä»¤ç‰Œå€¼</span>
                            <span class="info-value" id="displayTokenValue"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">è¿‡æœŸæ—¶é—´</span>
                            <span class="info-value" id="tokenExpiry"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æµé‡é™åˆ¶</span>
                            <span class="info-value" id="tokenLimit"> GB</span>
                        </div>
                    </div>
                </div>
                <div class="token-actions">
                    <button class="btn" onclick="copyToken()">
                        ğŸ“‹ å¤åˆ¶ä»¤ç‰Œ
                    </button>
                    <button class="btn btn-secondary" onclick="hideNewToken()">
                        âœ• å…³é—­
                    </button>
                </div>
            </div>
        </div>

        <!-- ç›´æ¥ä¸‹è½½å¡ç‰‡ -->
        <div class="card">
            <div class="card-title">
                <span>â¬‡ï¸ å®‰å…¨æ–‡ä»¶ä¸‹è½½</span>
            </div>
            <div class="form-group">
                <label class="form-label" for="fileUrl">æ–‡ä»¶é“¾æ¥</label>
                <input type="text" id="fileUrl" class="form-input"
                       placeholder="è¯·è¾“å…¥å®Œæ•´çš„æ–‡ä»¶URLï¼Œä¾‹å¦‚ï¼šhttps://wustwu.cn:8081/static/example.pdf">
                <div style="font-size: 12px; color: var(--secondary-color); margin-top: 5px;">
                    æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼šPDFã€æ–‡æ¡£ã€å›¾ç‰‡ã€è§†é¢‘ç­‰
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">ä¸‹è½½ä»¤ç‰Œ <span style="color: var(--danger-color);">*</span></label>
                <div class="token-input-group">
                    <div class="form-group">
                        <input type="text" id="downloadTokenId" class="form-input"
                               placeholder="ä»¤ç‰ŒID" required>
                        <div style="font-size: 12px; color: var(--secondary-color); margin-top: 5px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <input type="text" id="downloadTokenValue" class="form-input"
                               placeholder="ä»¤ç‰Œå€¼" required>
                        <button class="auto-fill-btn" onclick="autoFillToken()" title="ä½¿ç”¨å½“å‰ä»¤ç‰Œ">ğŸ”‘</button>
                        <div style="font-size: 12px; color: var(--secondary-color); margin-top: 5px;">
                        </div>
                    </div>
                </div>
                <div style="font-size: 12px; color: var(--secondary-color); margin-top: 5px;">
                    æ‰€æœ‰æ–‡ä»¶ä¸‹è½½éƒ½éœ€è¦ä»¤ç‰ŒIDå’Œä»¤ç‰Œå€¼éªŒè¯
                </div>

                <!-- å‰ªè´´æ¿æ“ä½œæŒ‰é’® -->
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn clipboard-btn" onclick="readFromClipboard()">
                        ğŸ“‹ ä»å‰ªè´´æ¿è¯»å–ä»¤ç‰Œ
                    </button>
                    <button class="btn btn-secondary clipboard-btn" onclick="enableAutoClipboard()" id="autoClipboardBtn">
                        ğŸ”„ å¯ç”¨è‡ªåŠ¨è¯»å–å‰ªè´´æ¿
                    </button>
                </div>
            </div>

            <button class="btn btn-success" onclick="startDownload()" id="downloadBtn">
                ğŸš€ å¼€å§‹ä¸‹è½½
            </button>
            <button class="btn btn-danger" onclick="cancelDownload()" id="cancelBtn" style="display: none; margin-left: 10px;">
                âŒ å–æ¶ˆä¸‹è½½
            </button>

            <!-- ä¸‹è½½è¿›åº¦æ˜¾ç¤º -->
            <div id="progressContainer" class="progress-container" style="display: none;">
                <div class="progress-header">
                    <div class="progress-title">ä¸‹è½½è¿›åº¦</div>
                    <div class="progress-percent" id="progressPercent">0%</div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-details">
                    <div class="progress-size">
                        å·²ä¸‹è½½: <span id="downloadedSize">0 B</span> / <span id="totalSize">0 B</span>
                    </div>
                    <div class="progress-speed" id="downloadSpeed">é€Ÿåº¦: 0 KB/s</div>
                    <div class="progress-time" id="timeRemaining">å‰©ä½™æ—¶é—´: è®¡ç®—ä¸­...</div>
                </div>
            </div>

            <!-- ä¸‹è½½é”™è¯¯è¯¦æƒ… -->
            <div id="downloadErrorDetails" class="download-error-details" style="display: none;">
                <div style="font-weight: 500; margin-bottom: 8px;">âš ï¸ ä¸‹è½½å¤±è´¥åŸå› :</div>
                <div id="errorMessage"></div>
                <div id="errorSolution" class="error-solution" style="display: none;">
                    <div style="font-weight: 500; margin-bottom: 5px;">ğŸ’¡ è§£å†³æ–¹æ¡ˆ:</div>
                    <div id="solutionText"></div>
                </div>
            </div>

            <!-- å¿«é€Ÿé“¾æ¥ç¤ºä¾‹ -->
            <div style="margin-top: 20px; padding: 15px; background: var(--bg-color); border-radius: 8px;">
                <div style="font-weight: 500; margin-bottom: 10px;">ğŸ“ å¿«é€Ÿä¸‹è½½ç¤ºä¾‹ï¼š</div>
                <div class="quick-links">
                    <button class="quick-link-btn" onclick="setExampleFile('example.pdf')">ç¤ºä¾‹PDF</button>
                    <button class="quick-link-btn" onclick="setExampleFile('document.docx')">ç¤ºä¾‹æ–‡æ¡£</button>
                    <button class="quick-link-btn" onclick="setExampleFile('image.jpg')">ç¤ºä¾‹å›¾ç‰‡</button>
                    <button class="quick-link-btn" onclick="setExampleFile('video.mp4')">ç¤ºä¾‹è§†é¢‘</button>
                    <button class="quick-link-btn" onclick="clearDownloadForm()" style="background: var(--secondary-color);">æ¸…ç©ºè¡¨å•</button>
                </div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜å¡ç‰‡ -->
        <div class="card">
            <div class="card-title">
                <span>ğŸ“– ä½¿ç”¨è¯´æ˜</span>
            </div>
            <div style="line-height: 1.8;">
                <h4>å¦‚ä½•ä½¿ç”¨ä¸‹è½½ä»¤ç‰Œï¼š</h4>
                <ol style="margin-left: 20px; margin-bottom: 20px;">
                    <li>ç‚¹å‡»ä¸Šæ–¹"ç”Ÿæˆä¸‹è½½ä»¤ç‰Œ"æŒ‰é’®åˆ›å»ºæ–°çš„ä»¤ç‰Œ</li>
                    <li>å¤åˆ¶ç”Ÿæˆçš„ä»¤ç‰ŒIDå’Œä»¤ç‰Œå€¼</li>
                    <li>åœ¨ä¸‹æ–¹è¾“å…¥æ–‡ä»¶é“¾æ¥ã€ä»¤ç‰ŒIDå’Œä»¤ç‰Œå€¼ï¼Œå¼€å§‹ä¸‹è½½</li>
                    <li>æˆ–è€…ä½¿ç”¨"ä»å‰ªè´´æ¿è¯»å–ä»¤ç‰Œ"è‡ªåŠ¨å¡«å…¥</li>
                </ol>
                <div class="token-display" style="background: var(--card-bg);">
                    https://wustwu.cn:9000/download?token_id=<strong>[ä»¤ç‰ŒID]</strong>&token=<strong>[ä»¤ç‰Œå€¼]</strong>&file=<strong>[æ–‡ä»¶å]</strong>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px;">
                    <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong>
                    <ul style="margin: 10px 0 0 20px;">
                        <li>æ¯ä¸ªä»¤ç‰Œæœ‰æ•ˆæœŸä¸º30åˆ†é’Ÿ</li>
                        <li>æ¯ä¸ªä»¤ç‰Œæœ€å¤šä¸‹è½½3GBæ•°æ®</li>
                        <li>è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„ä»¤ç‰Œï¼Œä¸è¦æ³„éœ²ç»™ä»–äºº</li>
                        <li>å¯éšæ—¶æ’¤é”€ä¸å†éœ€è¦çš„ä»¤ç‰Œ</li>
                        <li><strong>æ‰€æœ‰æ–‡ä»¶ä¸‹è½½éƒ½éœ€è¦ä»¤ç‰ŒIDå’Œä»¤ç‰Œå€¼éªŒè¯</strong></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ä»¤ç‰Œåˆ—è¡¨å¡ç‰‡ -->
        <div class="card">
            <div class="card-title">
                <span>ğŸ“‹ æˆ‘çš„ä¸‹è½½ä»¤ç‰Œ</span>
                <button class="btn btn-secondary" onclick="refreshTokens()"
                        style="margin-left: auto; padding: 8px 16px;">
                    ğŸ”„ åˆ·æ–°åˆ—è¡¨
                </button>
            </div>
            <div id="tokensList" class="tokens-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>åŠ è½½ä»¤ç‰Œåˆ—è¡¨...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // å…¨å±€å˜é‡
    const baseUrl = "https://wustwu.cn:9000";
    let currentUser = null;
    let currentToken = null;
    let debugMode = true;
    let downloadController = null;
    let downloadInProgress = false;
    let autoClipboardEnabled = false;
    let clipboardInterval = null;

    // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
    function showDebugInfo(message) {
        if (!debugMode) return;

        const debugContent = document.getElementById('debugContent');
        const timestamp = new Date().toLocaleTimeString();
        debugContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        debugContent.scrollTop = debugContent.scrollHeight;
    }

    // åˆ‡æ¢è°ƒè¯•é¢æ¿
    function toggleDebug() {
        const debugPanel = document.getElementById('debugPanel');
        const isVisible = debugPanel.style.display !== 'none';
        debugPanel.style.display = isVisible ? 'none' : 'block';
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
        showDebugInfo('é¡µé¢å¼€å§‹åŠ è½½...');
        checkAuthStatus();
        setupEventListeners();
        initTheme();

        // æ£€æŸ¥æ˜¯å¦å·²ç»å¯ç”¨è‡ªåŠ¨å‰ªè´´æ¿
        const savedAutoClipboard = localStorage.getItem('autoClipboardEnabled');
        if (savedAutoClipboard === 'true') {
            enableAutoClipboard();
        }
    });

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        // å›è½¦é”®ç”Ÿæˆä»¤ç‰Œ
        document.getElementById('tokenDescription').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                generateToken();
            }
        });

        // å®æ—¶éªŒè¯è¾“å…¥
        document.getElementById('fileUrl').addEventListener('input', validateDownloadForm);
        document.getElementById('downloadTokenId').addEventListener('input', validateDownloadForm);
        document.getElementById('downloadTokenValue').addEventListener('input', validateDownloadForm);
    }

    // éªŒè¯ä¸‹è½½è¡¨å•
    function validateDownloadForm() {
        const fileUrl = document.getElementById('fileUrl').value.trim();
        const tokenId = document.getElementById('downloadTokenId').value.trim();
        const tokenValue = document.getElementById('downloadTokenValue').value.trim();

        const fileUrlInput = document.getElementById('fileUrl');
        const tokenIdInput = document.getElementById('downloadTokenId');
        const tokenValueInput = document.getElementById('downloadTokenValue');

        // é‡ç½®é”™è¯¯çŠ¶æ€
        fileUrlInput.classList.remove('error');
        tokenIdInput.classList.remove('error');
        tokenValueInput.classList.remove('error');

        let isValid = true;

        if (!fileUrl) {
            fileUrlInput.classList.add('error');
            isValid = false;
        }

        if (!tokenId) {
            tokenIdInput.classList.add('error');
            isValid = false;
        }

        if (!tokenValue) {
            tokenValueInput.classList.add('error');
            isValid = false;
        }

        return isValid;
    }

    // æ£€æŸ¥è®¤è¯çŠ¶æ€
    function checkAuthStatus()  {
        showDebugInfo('å¼€å§‹è®¤è¯çŠ¶æ€æ£€æŸ¥...');

        // ç›´æ¥å°è¯•è°ƒç”¨è®¤è¯æ¥å£ï¼Œä¾èµ–æµè§ˆå™¨è‡ªåŠ¨å‘é€ cookie
        secureFetch(`${baseUrl}/check-auth`)
            .then(response => {
                showDebugInfo(`è®¤è¯æ£€æŸ¥å“åº”çŠ¶æ€: ${response.status}`);

                if (response.status === 401 || response.status === 403) {
                    throw new Error('ä¼šè¯æ— æ•ˆæˆ–å·²è¿‡æœŸ');
                }
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                showDebugInfo(`è®¤è¯æ£€æŸ¥è¿”å›æ•°æ®: ${JSON.stringify(data)}`);

                if (data.code === 200) {
                    currentUser = data.user;
                    showDebugInfo(`è®¤è¯æˆåŠŸï¼Œç”¨æˆ·: ${data.user.username}`);
                    showMainContent();
                } else {
                    throw new Error(data.message || 'è®¤è¯å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('è®¤è¯æ£€æŸ¥å¤±è´¥:', error);
                showDebugInfo(`è®¤è¯æ£€æŸ¥é”™è¯¯: ${error.message}`);
                showAuthError(`è®¤è¯å¤±è´¥: ${error.message}`);
            });
    }

    // æ˜¾ç¤ºè®¤è¯é”™è¯¯
    function showAuthError(message) {
        document.getElementById('authStatus').innerHTML = `
                <div class="alert alert-error">
                    âŒ ${message}
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn" onclick="window.location.href='index.html'">
                        ğŸ”„ è¿”å›ç™»å½•é¡µé¢
                    </button>
                    <button class="btn btn-secondary" onclick="checkAuthStatus()" style="margin-left: 10px;">
                        ğŸ” é‡æ–°æ£€æŸ¥
                    </button>
                </div>
            `;
    }

    // æ˜¾ç¤ºä¸»å†…å®¹
    function showMainContent() {
        showDebugInfo('æ˜¾ç¤ºä¸»å†…å®¹åŒºåŸŸ');

        // éšè—è®¤è¯çŠ¶æ€å¡ç‰‡
        document.getElementById('authStatusCard').style.display = 'none';

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å’Œä¸»è¦å†…å®¹
        document.getElementById('userInfo').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'block';

        updateUserInfo();
        loadTokens();

        // è®¾ç½®ä¸‹è½½è¡¨å•äº‹ä»¶ç›‘å¬
        setupDownloadFormListeners();

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showInfo('è®¤è¯æˆåŠŸï¼æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨ä¸‹è½½åŠŸèƒ½ã€‚');
    }

    // è®¾ç½®ä¸‹è½½è¡¨å•äº‹ä»¶ç›‘å¬
    function setupDownloadFormListeners() {
        // å›è½¦é”®è§¦å‘ä¸‹è½½
        document.getElementById('fileUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startDownload();
            }
        });

        document.getElementById('downloadTokenId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startDownload();
            }
        });

        document.getElementById('downloadTokenValue').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startDownload();
            }
        });
    }

    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
    function updateUserInfo() {
        if (currentUser) {
            document.getElementById('usernameDisplay').textContent = currentUser.username;
            document.getElementById('userRole').textContent =
                currentUser.permissions && currentUser.permissions.includes('admin') ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·';
            document.getElementById('userAvatar').textContent =
                currentUser.username.charAt(0).toUpperCase();

            showDebugInfo(`ç”¨æˆ·ä¿¡æ¯æ›´æ–°: ${currentUser.username}`);
        }
    }

    // ç”Ÿæˆä¸‹è½½ä»¤ç‰Œ
    function generateToken() {
        const description = document.getElementById('tokenDescription').value;
        const generateBtn = document.getElementById('generateBtn');

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        generateBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> ç”Ÿæˆä¸­...';
        generateBtn.disabled = true;

        hideAlerts();

        const tokenData = {
            description: description || 'ä¸´æ—¶ä¸‹è½½ä»¤ç‰Œ'
        };

        showDebugInfo('å¼€å§‹ç”Ÿæˆä¸‹è½½ä»¤ç‰Œ...');

        secureFetch(`${baseUrl}/generate-download-token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(tokenData)
        })
            .then(response => {
                showDebugInfo(`ç”Ÿæˆä»¤ç‰Œå“åº”çŠ¶æ€: ${response.status}`);

                if (!response.ok) {
                    throw new Error('ç”Ÿæˆä»¤ç‰Œå¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                showDebugInfo(`ç”Ÿæˆä»¤ç‰Œè¿”å›æ•°æ®: ${JSON.stringify(data)}`);

                if (data.code === 200) {
                    currentToken = data.data;
                    showNewToken(currentToken);
                    showSuccess('ä¸‹è½½ä»¤ç‰Œç”ŸæˆæˆåŠŸï¼');
                    loadTokens(); // åˆ·æ–°ä»¤ç‰Œåˆ—è¡¨
                } else {
                    throw new Error(data.message || 'ç”Ÿæˆä»¤ç‰Œå¤±è´¥');
                }
            })
            .catch(error => {
                console.error('ç”Ÿæˆä»¤ç‰Œé”™è¯¯:', error);
                showError(error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.innerHTML = 'ğŸ« ç”Ÿæˆä¸‹è½½ä»¤ç‰Œ';
                generateBtn.disabled = false;
            });
    }

    // æ˜¾ç¤ºæ–°ç”Ÿæˆçš„ä»¤ç‰Œ
    function showNewToken(tokenData) {
        document.getElementById('displayTokenId').textContent = tokenData.token_id;
        document.getElementById('displayTokenValue').textContent = tokenData.token;
        document.getElementById('tokenExpiry').textContent = tokenData.expires_at;
        document.getElementById('tokenLimit').textContent = tokenData.max_bytes/(1024 * 1024 * 1024)+" GB";
        document.getElementById('newTokenSection').style.display = 'block';

        showDebugInfo(`æ–°ä»¤ç‰Œç”Ÿæˆ: ${tokenData.token_id}`);

        // æ»šåŠ¨åˆ°ä»¤ç‰Œæ˜¾ç¤ºåŒºåŸŸ
        document.getElementById('newTokenSection').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });
    }

    // éšè—æ–°ä»¤ç‰Œæ˜¾ç¤º
    function hideNewToken() {
        document.getElementById('newTokenSection').style.display = 'none';
        document.getElementById('tokenDescription').value = '';
    }

    // å¤åˆ¶ä»¤ç‰Œåˆ°å‰ªè´´æ¿
    function copyToken() {
        const tokenId = document.getElementById('displayTokenId').textContent;
        const tokenValue = document.getElementById('displayTokenValue').textContent;

        const tokenData = `ä»¤ç‰ŒID: ${tokenId}\nä»¤ç‰Œå€¼: ${tokenValue}`;

        navigator.clipboard.writeText(tokenData).then(() => {
            showSuccess('ä»¤ç‰Œä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            showDebugInfo('ä»¤ç‰Œä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(err => {
            // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
            const textArea = document.createElement('textarea');
            textArea.value = tokenData;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showSuccess('ä»¤ç‰Œä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            showDebugInfo('ä½¿ç”¨å¤‡ç”¨æ–¹æ³•å¤åˆ¶ä»¤ç‰Œä¿¡æ¯');
        });
    }

    // ä»å‰ªè´´æ¿è¯»å–ä»¤ç‰Œ
    function readFromClipboard() {
        navigator.clipboard.readText().then(text => {
            showDebugInfo(`ä»å‰ªè´´æ¿è¯»å–å†…å®¹: ${text}`);
            parseAndFillToken(text);
        }).catch(err => {
            console.error('è¯»å–å‰ªè´´æ¿å¤±è´¥:', err);
            showError('è¯»å–å‰ªè´´æ¿å¤±è´¥ï¼Œè¯·ç¡®ä¿å·²æˆäºˆå‰ªè´´æ¿è®¿é—®æƒé™');
            showDebugInfo(`è¯»å–å‰ªè´´æ¿å¤±è´¥: ${err.message}`);
        });
    }

    // è§£æå¹¶å¡«å……ä»¤ç‰Œ
    function parseAndFillToken(text) {
        // å°è¯•å¤šç§æ ¼å¼è§£æ
        let tokenId = null;
        let tokenValue = null;

        showDebugInfo(`å¼€å§‹è§£æå‰ªè´´æ¿å†…å®¹: ${text}`);

        // æ ¼å¼1: ä»¤ç‰ŒID: xxxx\nä»¤ç‰Œå€¼: yyyy (æ‚¨æä¾›çš„æ ¼å¼)
        const format1 = text.match(/ä»¤ç‰ŒID:\s*([^\n\r]+)[\n\r]+ä»¤ç‰Œå€¼:\s*([^\n\r]+)/i);
        if (format1) {
            tokenId = format1[1].trim();
            tokenValue = format1[2].trim();
            showDebugInfo(`ä½¿ç”¨æ ¼å¼1è§£ææˆåŠŸ: ID=${tokenId}, Value=${tokenValue}`);
        }

        // æ ¼å¼2: ä»¤ç‰ŒID: xxxx ä»¤ç‰Œå€¼: yyyy (åŒä¸€è¡Œ)
        const format2 = text.match(/ä»¤ç‰ŒID:\s*([^\s]+)\s+ä»¤ç‰Œå€¼:\s*([^\n\r]+)/i);
        if (format2 && !tokenId) {
            tokenId = format2[1].trim();
            tokenValue = format2[2].trim();
            showDebugInfo(`ä½¿ç”¨æ ¼å¼2è§£ææˆåŠŸ: ID=${tokenId}, Value=${tokenValue}`);
        }

        // æ ¼å¼3: åªæœ‰ä»¤ç‰ŒIDå’Œä»¤ç‰Œå€¼ï¼Œæ²¡æœ‰æ ‡ç­¾
        const lines = text.split(/[\n\r]+/);
        if (lines.length >= 2 && !tokenId) {
            const line1 = lines[0].trim();
            const line2 = lines[1].trim();

            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ä»¤ç‰Œæ ¼å¼ï¼ˆé€šå¸¸ä»¤ç‰ŒIDå’Œä»¤ç‰Œå€¼éƒ½æ˜¯ç‰¹å®šé•¿åº¦çš„å­—ç¬¦ä¸²ï¼‰
            if (line1.length > 5 && line2.length > 5 && !line1.includes('ï¼š') && !line2.includes('ï¼š')) {
                tokenId = line1;
                tokenValue = line2;
                showDebugInfo(`ä½¿ç”¨æ ¼å¼3è§£ææˆåŠŸ: ID=${tokenId}, Value=${tokenValue}`);
            }
        }

        // æ ¼å¼4: å•è¡Œï¼Œç”¨ç©ºæ ¼æˆ–åˆ¶è¡¨ç¬¦åˆ†éš”
        const parts = text.split(/[\s\t]+/);
        if (parts.length >= 2 && !tokenId) {
            if (parts[0].length > 5 && parts[1].length > 5) {
                tokenId = parts[0];
                tokenValue = parts[1];
                showDebugInfo(`ä½¿ç”¨æ ¼å¼4è§£ææˆåŠŸ: ID=${tokenId}, Value=${tokenValue}`);
            }
        }

        // æ ¼å¼5: ä¸­æ–‡å†’å·æ ¼å¼ (æ”¯æŒå…¨è§’å†’å·)
        const format5 = text.match(/ä»¤ç‰ŒID[ï¼š:]\s*([^\n\r]+)[\n\r]+ä»¤ç‰Œå€¼[ï¼š:]\s*([^\n\r]+)/i);
        if (format5 && !tokenId) {
            tokenId = format5[1].trim();
            tokenValue = format5[2].trim();
            showDebugInfo(`ä½¿ç”¨æ ¼å¼5è§£ææˆåŠŸ: ID=${tokenId}, Value=${tokenValue}`);
        }

        if (tokenId && tokenValue) {
            document.getElementById('downloadTokenId').value = tokenId;
            document.getElementById('downloadTokenValue').value = tokenValue;
            showSuccess('å·²ä»å‰ªè´´æ¿è‡ªåŠ¨å¡«å…¥ä»¤ç‰Œä¿¡æ¯');
            showDebugInfo(`æœ€ç»ˆè§£æç»“æœ: ID=${tokenId}, Value=${tokenValue}`);
        } else {
            showError('æ— æ³•ä»å‰ªè´´æ¿å†…å®¹ä¸­è¯†åˆ«å‡ºä»¤ç‰Œä¿¡æ¯ï¼Œè¯·ç¡®ä¿æ ¼å¼ä¸ºï¼šä»¤ç‰ŒID: xxxx ä»¤ç‰Œå€¼: yyyy');
            showDebugInfo('æ‰€æœ‰æ ¼å¼è§£æéƒ½å¤±è´¥äº†ï¼Œå‰ªè´´æ¿å†…å®¹æ— æ³•è¯†åˆ«');
        }
    }

    // å¯ç”¨è‡ªåŠ¨è¯»å–å‰ªè´´æ¿
    function enableAutoClipboard() {
        if (autoClipboardEnabled) {
            // å¦‚æœå·²ç»å¯ç”¨ï¼Œåˆ™ç¦ç”¨
            autoClipboardEnabled = false;
            clearInterval(clipboardInterval);
            document.getElementById('autoClipboardBtn').textContent = 'ğŸ”„ å¯ç”¨è‡ªåŠ¨è¯»å–å‰ªè´´æ¿';
            localStorage.setItem('autoClipboardEnabled', 'false');
            showInfo('å·²ç¦ç”¨è‡ªåŠ¨è¯»å–å‰ªè´´æ¿');
            showDebugInfo('ç¦ç”¨è‡ªåŠ¨è¯»å–å‰ªè´´æ¿');
            return;
        }

        // è¯·æ±‚å‰ªè´´æ¿è¯»å–æƒé™
        navigator.permissions.query({ name: 'clipboard-read' }).then(permissionStatus => {
            if (permissionStatus.state === 'granted' || permissionStatus.state === 'prompt') {
                autoClipboardEnabled = true;
                document.getElementById('autoClipboardBtn').textContent = 'â¹ï¸ åœæ­¢è‡ªåŠ¨è¯»å–';
                localStorage.setItem('autoClipboardEnabled', 'true');

                // è®¾ç½®å®šæœŸæ£€æŸ¥å‰ªè´´æ¿
                clipboardInterval = setInterval(() => {
                    if (autoClipboardEnabled) {
                        navigator.clipboard.readText().then(text => {
                            // åªæœ‰å½“ä¸¤ä¸ªè¾“å…¥æ¡†éƒ½ä¸ºç©ºæ—¶æ‰è‡ªåŠ¨å¡«å……
                            const tokenIdInput = document.getElementById('downloadTokenId');
                            const tokenValueInput = document.getElementById('downloadTokenValue');

                            if (!tokenIdInput.value && !tokenValueInput.value && text.trim()) {
                                parseAndFillToken(text);
                            }
                        }).catch(err => {
                            // æƒé™é”™è¯¯ï¼Œåœæ­¢è‡ªåŠ¨è¯»å–
                            if (err.name === 'NotAllowedError') {
                                autoClipboardEnabled = false;
                                clearInterval(clipboardInterval);
                                document.getElementById('autoClipboardBtn').textContent = 'ğŸ”„ å¯ç”¨è‡ªåŠ¨è¯»å–å‰ªè´´æ¿';
                                localStorage.setItem('autoClipboardEnabled', 'false');
                                showError('è‡ªåŠ¨è¯»å–å‰ªè´´æ¿æƒé™å·²ä¸¢å¤±');
                                showDebugInfo('è‡ªåŠ¨è¯»å–å‰ªè´´æ¿æƒé™ä¸¢å¤±');
                            }
                        });
                    }
                }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡

                showSuccess('å·²å¯ç”¨è‡ªåŠ¨è¯»å–å‰ªè´´æ¿ï¼Œå½“å‰ªè´´æ¿ä¸­æœ‰ä»¤ç‰Œä¿¡æ¯æ—¶ä¼šè‡ªåŠ¨å¡«å…¥');
                showDebugInfo('å¯ç”¨è‡ªåŠ¨è¯»å–å‰ªè´´æ¿');
            } else {
                showError('æµè§ˆå™¨ä¸å…è®¸è¯»å–å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨æˆæƒ');
            }
        }).catch(err => {
            console.error('æ£€æŸ¥å‰ªè´´æ¿æƒé™å¤±è´¥:', err);
            showError('æ£€æŸ¥å‰ªè´´æ¿æƒé™å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æˆæƒ');
        });
    }

    // åŠ è½½ä»¤ç‰Œåˆ—è¡¨
    function loadTokens() {
        const tokensList = document.getElementById('tokensList');

        showDebugInfo('å¼€å§‹åŠ è½½ä»¤ç‰Œåˆ—è¡¨...');

        secureFetch(`${baseUrl}/list-download-tokens`)
            .then(response => {
                showDebugInfo(`åŠ è½½ä»¤ç‰Œåˆ—è¡¨å“åº”çŠ¶æ€: ${response.status}`);

                if (!response.ok) {
                    throw new Error('è·å–ä»¤ç‰Œåˆ—è¡¨å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                showDebugInfo(`åŠ è½½ä»¤ç‰Œåˆ—è¡¨è¿”å›æ•°æ®: ${JSON.stringify(data).substring(0, 200)}...`);

                if (data.code === 200) {
                    displayTokens(data.data || []);
                } else {
                    throw new Error(data.message || 'è·å–ä»¤ç‰Œåˆ—è¡¨å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('åŠ è½½ä»¤ç‰Œåˆ—è¡¨é”™è¯¯:', error);
                tokensList.innerHTML = `
                        <div class="alert alert-error">
                            âŒ åŠ è½½ä»¤ç‰Œåˆ—è¡¨å¤±è´¥: ${error.message}
                        </div>
                    `;
                showDebugInfo(`åŠ è½½ä»¤ç‰Œåˆ—è¡¨å¤±è´¥: ${error.message}`);
            });
    }

    // æ˜¾ç¤ºä»¤ç‰Œåˆ—è¡¨ - ä¿®æ”¹ä¸ºæ˜¾ç¤ºä»¤ç‰ŒIDã€ä»¤ç‰Œå€¼ã€åˆ›å»ºæ—¶é—´ã€å¤±æ•ˆæ—¶é—´å’Œå‰©ä½™æµé‡
    function displayTokens(tokens) {
        const tokensList = document.getElementById('tokensList');

        if (!tokens || tokens.length === 0) {
            tokensList.innerHTML = `
                    <div class="empty-state">
                        <div>ğŸ“­</div>
                        <h3>æš‚æ— ä¸‹è½½ä»¤ç‰Œ</h3>
                        <p>ç‚¹å‡»ä¸Šæ–¹"ç”Ÿæˆä¸‹è½½ä»¤ç‰Œ"æŒ‰é’®åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªä»¤ç‰Œ</p>
                    </div>
                `;
            showDebugInfo('ä»¤ç‰Œåˆ—è¡¨ä¸ºç©º');
            return;
        }

        // æŒ‰åˆ›å»ºæ—¶é—´é™åºæ’åº
        tokens.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        tokensList.innerHTML = tokens.map(token => {
            // è®¡ç®—å‰©ä½™æµé‡
            const remainingBytes = token.max_bytes - token.used_bytes;
            const remainingBytesFormatted = formatBytes(remainingBytes);
            const maxBytesFormatted = formatBytes(token.max_bytes);

            // è®¡ç®—å‰©ä½™æµé‡ç™¾åˆ†æ¯”
            const remainingPercentage = Math.max(0, (remainingBytes / token.max_bytes) * 100);

            // åˆ¤æ–­æµé‡ä½¿ç”¨çŠ¶æ€
            let usageClass = '';
            if (remainingPercentage < 10) {
                usageClass = 'usage-danger';
            } else if (remainingPercentage < 30) {
                usageClass = 'usage-warning';
            }

            return `
                <div class="token-item">
                    <div class="token-header">
                        <div class="token-id">${token.token_id}</div>
                        <div class="token-status ${getStatusClass(token)}">
                            ${getStatusText(token)}
                        </div>
                    </div>
                    <div class="token-details">
                        <div class="info-item">
                            <span class="info-label">ä»¤ç‰Œå€¼</span>
                            <span class="info-value" style="font-family: 'Courier New', monospace; word-break: break-all;">${token.token || 'æœªä¿å­˜'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">åˆ›å»ºæ—¶é—´</span>
                            <span class="info-value">${formatDate(token.created_at)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å¤±æ•ˆæ—¶é—´</span>
                            <span class="info-value">${formatDate(token.expires_at)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å‰©ä½™æµé‡</span>
                            <span class="info-value">${remainingBytesFormatted} / ${maxBytesFormatted}</span>
                        </div>
                    </div>
                    <div class="usage-bar">
                        <div class="usage-progress ${usageClass}" style="width: ${remainingPercentage}%"></div>
                    </div>
                    ${token.is_active ? `
                    <div class="token-actions">
                        <button class="btn btn-danger" onclick="revokeToken('${token.token_id}')"
                                style="padding: 6px 12px; font-size: 12px;">
                            ğŸš« æ’¤é”€ä»¤ç‰Œ
                        </button>
                        <button class="btn" onclick="copyTokenFromList('${token.token_id}', '${token.token || ''}')"
                                style="padding: 6px 12px; font-size: 12px;">
                            ğŸ“‹ å¤åˆ¶ä»¤ç‰Œ
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
        }).join('');

        showDebugInfo(`æ˜¾ç¤º ${tokens.length} ä¸ªä»¤ç‰Œ`);
    }

    // å¤åˆ¶ä»¤ç‰Œåˆ—è¡¨ä¸­çš„ä»¤ç‰Œ
    function copyTokenFromList(tokenId, tokenValue) {
        if (!tokenValue) {
            showError('è¯¥ä»¤ç‰Œçš„å€¼æœªä¿å­˜ï¼Œæ— æ³•å¤åˆ¶');
            return;
        }

        const tokenData = `ä»¤ç‰ŒID: ${tokenId}\nä»¤ç‰Œå€¼: ${tokenValue}`;

        navigator.clipboard.writeText(tokenData).then(() => {
            showSuccess('ä»¤ç‰Œä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            showDebugInfo('ä»¤ç‰Œåˆ—è¡¨ä¸­çš„ä»¤ç‰Œä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(err => {
            // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
            const textArea = document.createElement('textarea');
            textArea.value = tokenData;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showSuccess('ä»¤ç‰Œä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            showDebugInfo('ä½¿ç”¨å¤‡ç”¨æ–¹æ³•å¤åˆ¶ä»¤ç‰Œåˆ—è¡¨ä¸­çš„ä»¤ç‰Œä¿¡æ¯');
        });
    }

    // è·å–ä»¤ç‰ŒçŠ¶æ€ç±»
    function getStatusClass(token) {
        if (!token.is_active) return 'status-revoked';
        if (new Date(token.expires_at) < new Date()) return 'status-expired';
        return 'status-active';
    }

    // è·å–ä»¤ç‰ŒçŠ¶æ€æ–‡æœ¬
    function getStatusText(token) {
        if (!token.is_active) return 'å·²æ’¤é”€';
        if (new Date(token.expires_at) < new Date()) return 'å·²è¿‡æœŸ';
        return 'æ´»è·ƒ';
    }

    // æ’¤é”€ä»¤ç‰Œ
    function revokeToken(tokenId) {
        if (!confirm('ç¡®å®šè¦æ’¤é”€è¿™ä¸ªä¸‹è½½ä»¤ç‰Œå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
            return;
        }

        showDebugInfo(`å¼€å§‹æ’¤é”€ä»¤ç‰Œ: ${tokenId}`);

        secureFetch(`${baseUrl}/revoke-download-token?token_id=${tokenId}`, {
            method: 'POST'
        })
            .then(response => {
                showDebugInfo(`æ’¤é”€ä»¤ç‰Œå“åº”çŠ¶æ€: ${response.status}`);

                if (!response.ok) {
                    throw new Error('æ’¤é”€ä»¤ç‰Œå¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                showDebugInfo(`æ’¤é”€ä»¤ç‰Œè¿”å›æ•°æ®: ${JSON.stringify(data)}`);

                if (data.code === 200) {
                    showSuccess('ä»¤ç‰Œå·²æˆåŠŸæ’¤é”€');
                    loadTokens(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    throw new Error(data.message || 'æ’¤é”€ä»¤ç‰Œå¤±è´¥');
                }
            })
            .catch(error => {
                console.error('æ’¤é”€ä»¤ç‰Œé”™è¯¯:', error);
                showError(error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            });
    }

    // åˆ·æ–°ä»¤ç‰Œåˆ—è¡¨
    function refreshTokens() {
        loadTokens();
        showSuccess('ä»¤ç‰Œåˆ—è¡¨å·²åˆ·æ–°');
        showDebugInfo('æ‰‹åŠ¨åˆ·æ–°ä»¤ç‰Œåˆ—è¡¨');
    }

    // ==================== å¸¦è¿›åº¦æ˜¾ç¤ºçš„ä¸‹è½½åŠŸèƒ½ ====================

    // å¼€å§‹ä¸‹è½½
    function startDownload() {
        const fileUrl = document.getElementById('fileUrl').value.trim();
        const tokenId = document.getElementById('downloadTokenId').value.trim();
        const tokenValue = document.getElementById('downloadTokenValue').value.trim();
        const downloadBtn = document.getElementById('downloadBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        // éªŒè¯è¾“å…¥
        if (!fileUrl) {
            showError('è¯·è¾“å…¥æ–‡ä»¶é“¾æ¥');
            highlightErrorField('fileUrl');
            return;
        }

        if (!tokenId) {
            showError('è¯·è¾“å…¥ä»¤ç‰ŒID');
            highlightErrorField('downloadTokenId');
            return;
        }

        if (!tokenValue) {
            showError('è¯·è¾“å…¥ä»¤ç‰Œå€¼');
            highlightErrorField('downloadTokenValue');
            return;
        }

        // éªŒè¯URLæ ¼å¼
        if (!isValidUrl(fileUrl)) {
            showError('è¯·è¾“å…¥æœ‰æ•ˆçš„æ–‡ä»¶URLé“¾æ¥');
            highlightErrorField('fileUrl');
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        downloadBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> å‡†å¤‡ä¸­...';
        downloadBtn.disabled = true;
        cancelBtn.style.display = 'inline-flex';

        hideAlerts();
        hideDownloadError();
        showDebugInfo(`å¼€å§‹ä¸‹è½½: ${fileUrl}`);

        // æ˜¾ç¤ºè¿›åº¦å®¹å™¨
        document.getElementById('progressContainer').style.display = 'block';
        resetProgress();

        // è®¾ç½®å–æ¶ˆæ§åˆ¶å™¨
        downloadController = new AbortController();
        downloadInProgress = true;

        // æå–æ–‡ä»¶è·¯å¾„
        const filePath = extractFilePath(fileUrl);
        if (!filePath) {
            const errorMsg = 'æ— æ³•è§£ææ–‡ä»¶è·¯å¾„ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶é“¾æ¥æ ¼å¼';
            showDownloadError(errorMsg, 'è¯·ç¡®ä¿æ–‡ä»¶é“¾æ¥æ ¼å¼æ­£ç¡®ï¼Œä¾‹å¦‚ï¼šhttps://wustwu.cn:8081/static/example.pdf');
            resetDownloadButton();
            return;
        }

        // æ„å»ºä¸‹è½½URL - ä½¿ç”¨ä»¤ç‰ŒIDå’Œä»¤ç‰Œå€¼ä¸¤ä¸ªå‚æ•°
        const downloadUrl = `${baseUrl}/download?token_id=${encodeURIComponent(tokenId)}&token=${encodeURIComponent(tokenValue)}&file=${encodeURIComponent(filePath)}`;
        showDebugInfo(`ä¸‹è½½URL: ${downloadUrl}`);

        // è®¾ç½®è¶…æ—¶ï¼ˆ30ç§’ï¼‰
        const timeoutId = setTimeout(() => {
            if (downloadInProgress) {
                downloadController.abort();
                const errorMsg = 'ä¸‹è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æ–‡ä»¶å¤§å°';
                const solution = '1. æ£€æŸ¥ç½‘ç»œè¿æ¥<br>2. å¦‚æœæ–‡ä»¶è¾ƒå¤§ï¼Œè¯·è€å¿ƒç­‰å¾…<br>3. å°è¯•é‡æ–°ä¸‹è½½';
                showDownloadError(errorMsg, solution);
                showDebugInfo('ä¸‹è½½è¶…æ—¶ï¼Œå·²å–æ¶ˆ');
            }
        }, 10*60000);

        // å¼€å§‹ä¸‹è½½
        fetchWithProgress(downloadUrl, filePath)
            .then(() => {
                clearTimeout(timeoutId);
                showSuccess(`æ–‡ä»¶ä¸‹è½½å®Œæˆ: ${getFileNameFromUrl(fileUrl)}`);
                showDebugInfo('ä¸‹è½½å®Œæˆ');
            })
            .catch(error => {
                clearTimeout(timeoutId);
                if (error.name !== 'AbortError') {
                    console.error('ä¸‹è½½é”™è¯¯:', error);
                    let errorMsg = `ä¸‹è½½å¤±è´¥: ${error.message}`;
                    let solution = '';

                    // æ ¹æ®é”™è¯¯ç±»å‹æä¾›å…·ä½“çš„è§£å†³æ–¹æ¡ˆ
                    if (error.message.includes('404')) {
                        errorMsg = 'æ–‡ä»¶æœªæ‰¾åˆ° (404é”™è¯¯)';
                        solution = '1. æ£€æŸ¥æ–‡ä»¶é“¾æ¥æ˜¯å¦æ­£ç¡®<br>2. ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨<br>3. è”ç³»ç®¡ç†å‘˜ç¡®è®¤æ–‡ä»¶çŠ¶æ€';
                    } else if (error.message.includes('403')) {
                        errorMsg = 'è®¿é—®è¢«æ‹’ç» (403é”™è¯¯)';
                        solution = '1. æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦æ­£ç¡®<br>2. ç¡®è®¤ä»¤ç‰Œæ˜¯å¦å·²è¿‡æœŸæˆ–è¢«æ’¤é”€<br>3. ç¡®è®¤æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥æ–‡ä»¶';
                    } else if (error.message.includes('401')) {
                        errorMsg = 'è®¤è¯å¤±è´¥ (401é”™è¯¯)';
                        solution = '1. æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦æ­£ç¡®<br>2. é‡æ–°ç”Ÿæˆä»¤ç‰Œ<br>3. é‡æ–°ç™»å½•ç³»ç»Ÿ';
                    } else if (error.message.includes('network') || error.message.includes('Network')) {
                        errorMsg = 'ç½‘ç»œè¿æ¥é”™è¯¯';
                        solution = '1. æ£€æŸ¥ç½‘ç»œè¿æ¥<br>2. æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€<br>3. ç¨åé‡è¯•';
                    } else if (error.message.includes('CORS')) {
                        errorMsg = 'è·¨åŸŸè®¿é—®é”™è¯¯';
                        solution = '1. è¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥æœåŠ¡å™¨CORSé…ç½®<br>2. å°è¯•ä½¿ç”¨å…¶ä»–æµè§ˆå™¨';
                    }

                    showDownloadError(errorMsg, solution);
                    showDebugInfo(`ä¸‹è½½é”™è¯¯: ${error.message}`);
                } else {
                    showInfo('ä¸‹è½½å·²å–æ¶ˆ');
                    showDebugInfo('ä¸‹è½½å·²å–æ¶ˆ');
                }
            })
            .finally(() => {
                resetDownloadButton();
                downloadInProgress = false;
            });
    }

    // é«˜äº®æ˜¾ç¤ºé”™è¯¯å­—æ®µ
    function highlightErrorField(fieldId) {
        const field = document.getElementById(fieldId);
        field.classList.add('error');
        field.focus();

        // 3ç§’åç§»é™¤é”™è¯¯æ ·å¼
        setTimeout(() => {
            field.classList.remove('error');
        }, 3000);
    }

    // éªŒè¯URLæ ¼å¼
    function isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }

    // æ˜¾ç¤ºä¸‹è½½é”™è¯¯è¯¦æƒ…
    function showDownloadError(errorMessage, solution = '') {
        const errorDetails = document.getElementById('downloadErrorDetails');
        const errorMessageEl = document.getElementById('errorMessage');
        const errorSolution = document.getElementById('errorSolution');
        const solutionText = document.getElementById('solutionText');

        errorMessageEl.textContent = errorMessage;

        if (solution) {
            solutionText.innerHTML = solution;
            errorSolution.style.display = 'block';
        } else {
            errorSolution.style.display = 'none';
        }

        errorDetails.style.display = 'block';
        showError('ä¸‹è½½å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹é”™è¯¯è¯¦æƒ…');

        // æ»šåŠ¨åˆ°é”™è¯¯è¯¦æƒ…
        errorDetails.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });
    }

    // éšè—ä¸‹è½½é”™è¯¯è¯¦æƒ…
    function hideDownloadError() {
        document.getElementById('downloadErrorDetails').style.display = 'none';
    }

    // å¢å¼ºçš„æ–‡ä»¶è·¯å¾„æå–å‡½æ•°
    function extractFilePath(fileUrl) {
        try {
            console.log('åŸå§‹æ–‡ä»¶URL:', fileUrl);

            // å…ˆè§£ç æ•´ä¸ªURLï¼ˆå¤„ç†å¯èƒ½çš„å¤šé‡ç¼–ç ï¼‰
            let decodedUrl = fileUrl;
            try {
                decodedUrl = decodeURIComponent(fileUrl);
            } catch (e) {
                // å¦‚æœè§£ç å¤±è´¥ï¼Œä¿æŒåŸæ ·
                console.log('URLè§£ç å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹URL');
            }

            console.log('è§£ç åURL:', decodedUrl);

            return decodedUrl;

        } catch (error) {
            console.error('URLè§£æé”™è¯¯:', error);

            // å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨æå–
            const staticBase = 'https://wustwu.cn:8081/static/';
            if (fileUrl.includes(staticBase)) {
                let startIndex = fileUrl.indexOf(staticBase) + staticBase.length;
                let path = fileUrl.substring(startIndex);

                // è§£ç è·¯å¾„
                try {
                    path = decodeURIComponent(path);
                } catch (e) {
                    console.log('è·¯å¾„è§£ç å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹è·¯å¾„');
                }

                console.log('æ‰‹åŠ¨æå–çš„æ–‡ä»¶è·¯å¾„:', path);
                return path;
            }

            return null;
        }
    }

    // å¸¦è¿›åº¦æ˜¾ç¤ºçš„ä¸‹è½½
    function fetchWithProgress(url, filename) {
        return new Promise((resolve, reject) => {
            fetch(url, {
                signal: downloadController.signal,
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const contentLength = response.headers.get('Content-Length');
                    const total = parseInt(contentLength, 10);
                    let loaded = 0;
                    let startTime = Date.now();

                    if (!contentLength) {
                        showDebugInfo('æ— æ³•è·å–æ–‡ä»¶å¤§å°ï¼Œè¿›åº¦æ˜¾ç¤ºå¯èƒ½ä¸å‡†ç¡®');
                    }

                    const reader = response.body.getReader();
                    const chunks = [];

                    function read() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                // ä¸‹è½½å®Œæˆ
                                const blob = new Blob(chunks);
                                const downloadUrl = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = downloadUrl;
                                a.download = filename;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                window.URL.revokeObjectURL(downloadUrl);

                                // æ›´æ–°è¿›åº¦ä¸º100%
                                updateProgress(total, total);
                                resolve();
                                return;
                            }

                            loaded += value.length;
                            chunks.push(value);

                            // æ›´æ–°è¿›åº¦
                            updateProgress(loaded, total, startTime);

                            // ç»§ç»­è¯»å–
                            read();
                        }).catch(reject);
                    }

                    read();
                })
                .catch(reject);
        });
    }

    // æ›´æ–°ä¸‹è½½è¿›åº¦
    function updateProgress(loaded, total, startTime) {
        const progressPercent = document.getElementById('progressPercent');
        const progressBar = document.getElementById('progressBar');
        const downloadedSize = document.getElementById('downloadedSize');
        const totalSize = document.getElementById('totalSize');
        const downloadSpeed = document.getElementById('downloadSpeed');
        const timeRemaining = document.getElementById('timeRemaining');

        // è®¡ç®—ç™¾åˆ†æ¯”
        let percent = 0;
        if (total > 0) {
            percent = Math.min(100, (loaded / total) * 100);
        }

        // æ›´æ–°UI
        progressPercent.textContent = `${percent.toFixed(1)}%`;
        progressBar.style.width = `${percent}%`;
        downloadedSize.textContent = formatBytes(loaded);
        totalSize.textContent = total > 0 ? formatBytes(total) : 'æœªçŸ¥';

        // è®¡ç®—ä¸‹è½½é€Ÿåº¦å’Œå‰©ä½™æ—¶é—´
        if (startTime && loaded > 0) {
            const elapsedTime = (Date.now() - startTime) / 1000; // ç§’
            const speed = loaded / elapsedTime; // å­—èŠ‚/ç§’

            downloadSpeed.textContent = `é€Ÿåº¦: ${formatBytes(speed)}/s`;

            if (total > 0 && speed > 0) {
                const remainingBytes = total - loaded;
                const remainingTime = remainingBytes / speed;
                timeRemaining.textContent = `å‰©ä½™æ—¶é—´: ${formatTime(remainingTime)}`;
            } else {
                timeRemaining.textContent = 'å‰©ä½™æ—¶é—´: è®¡ç®—ä¸­...';
            }
        }
    }

    // é‡ç½®è¿›åº¦æ˜¾ç¤º
    function resetProgress() {
        document.getElementById('progressPercent').textContent = '0%';
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('downloadedSize').textContent = '0 B';
        document.getElementById('totalSize').textContent = '0 B';
        document.getElementById('downloadSpeed').textContent = 'é€Ÿåº¦: 0 KB/s';
        document.getElementById('timeRemaining').textContent = 'å‰©ä½™æ—¶é—´: è®¡ç®—ä¸­...';
    }

    // é‡ç½®ä¸‹è½½æŒ‰é’®çŠ¶æ€
    function resetDownloadButton() {
        const downloadBtn = document.getElementById('downloadBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        downloadBtn.innerHTML = 'ğŸš€ å¼€å§‹ä¸‹è½½';
        downloadBtn.disabled = false;
        cancelBtn.style.display = 'none';
    }

    // å–æ¶ˆä¸‹è½½
    function cancelDownload() {
        if (downloadController && downloadInProgress) {
            downloadController.abort();
            downloadInProgress = false;
            resetDownloadButton();
            showInfo('ä¸‹è½½å·²å–æ¶ˆ');
            showDebugInfo('ç”¨æˆ·å–æ¶ˆäº†ä¸‹è½½');
        }
    }

    // ä»URLä¸­æå–æ–‡ä»¶å
    function getFileNameFromUrl(url) {
        try {
            const urlObj = new URL(url);
            const pathname = urlObj.pathname;
            return pathname.split('/').pop() || 'download';
        } catch (error) {
            // å¦‚æœURLè§£æå¤±è´¥ï¼Œå°è¯•ä»å­—ç¬¦ä¸²ä¸­æå–
            const segments = url.split('/');
            return segments.pop() || 'download';
        }
    }

    // è®¾ç½®ç¤ºä¾‹æ–‡ä»¶
    function setExampleFile(filename) {
        const baseUrl = 'https://wustwu.cn:8081/static';
        const exampleUrl = `${baseUrl}/${filename}`;

        document.getElementById('fileUrl').value = exampleUrl;
        showDebugInfo(`è®¾ç½®ç¤ºä¾‹æ–‡ä»¶: ${exampleUrl}`);

        // å¦‚æœæœ‰å½“å‰ä»¤ç‰Œï¼Œè‡ªåŠ¨å¡«å…¥
        if (currentToken) {
            document.getElementById('downloadTokenId').value = currentToken.token_id;
            document.getElementById('downloadTokenValue').value = currentToken.token;
        }

        showInfo(`å·²è®¾ç½®ç¤ºä¾‹æ–‡ä»¶: ${filename}`);
    }

    // è‡ªåŠ¨å¡«å…¥å½“å‰ä»¤ç‰Œ
    function autoFillToken() {
        if (currentToken) {
            document.getElementById('downloadTokenId').value = currentToken.token_id;
            document.getElementById('downloadTokenValue').value = currentToken.token;
            showSuccess('å·²è‡ªåŠ¨å¡«å…¥å½“å‰ä»¤ç‰Œ');
            showDebugInfo('è‡ªåŠ¨å¡«å…¥å½“å‰ä»¤ç‰Œ');
        } else {
            showError('è¯·å…ˆç”Ÿæˆä¸‹è½½ä»¤ç‰Œ');
        }
    }

    // æ¸…ç©ºä¸‹è½½è¡¨å•
    function clearDownloadForm() {
        document.getElementById('fileUrl').value = '';
        document.getElementById('downloadTokenId').value = '';
        document.getElementById('downloadTokenValue').value = '';
        document.getElementById('progressContainer').style.display = 'none';
        document.getElementById('downloadErrorDetails').style.display = 'none';
        showDebugInfo('æ¸…ç©ºä¸‹è½½è¡¨å•');
        showInfo('ä¸‹è½½è¡¨å•å·²æ¸…ç©º');
    }

    // ==================== é€šç”¨åŠŸèƒ½ ====================

    // é€€å‡ºç™»å½•
    function logout() {
        showDebugInfo('å¼€å§‹é€€å‡ºç™»å½•...');

        secureFetch(`${baseUrl}/logout`, {
            method: 'POST'
        })
            .then(() => {
                showDebugInfo('é€€å‡ºç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°é¦–é¡µ');
                window.location.href = 'index.html';
            })
            .catch(error => {
                console.error('é€€å‡ºç™»å½•é”™è¯¯:', error);
                showDebugInfo(`é€€å‡ºç™»å½•å¤±è´¥: ${error.message}`);
                window.location.href = 'index.html';
            });
    }

    // åˆ‡æ¢ä¸»é¢˜
    function toggleTheme() {
        const currentTheme = document.body.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('manualTheme', newTheme);
        showDebugInfo(`ä¸»é¢˜åˆ‡æ¢ä¸º: ${newTheme}`);
    }

    // åˆå§‹åŒ–ä¸»é¢˜
    function initTheme() {
        const savedTheme = localStorage.getItem('manualTheme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        showDebugInfo(`åˆå§‹åŒ–ä¸»é¢˜: ${savedTheme}`);
    }

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccess(message) {
        const alert = document.getElementById('successAlert');
        alert.innerHTML = `âœ… ${message}`;
        alert.style.display = 'block';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 5000);
        showDebugInfo(`æˆåŠŸæ¶ˆæ¯: ${message}`);
    }

    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    function showError(message) {
        const alert = document.getElementById('errorAlert');
        alert.innerHTML = `âŒ ${message}`;
        alert.style.display = 'block';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 5000);
        showDebugInfo(`é”™è¯¯æ¶ˆæ¯: ${message}`);
    }

    // æ˜¾ç¤ºä¿¡æ¯æ¶ˆæ¯
    function showInfo(message) {
        const alert = document.getElementById('infoAlert');
        alert.innerHTML = `â„¹ï¸ ${message}`;
        alert.style.display = 'block';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 5000);
        showDebugInfo(`ä¿¡æ¯æ¶ˆæ¯: ${message}`);
    }

    // æ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯
    function showWarning(message) {
        const alert = document.getElementById('warningAlert');
        alert.innerHTML = `âš ï¸ ${message}`;
        alert.style.display = 'block';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 5000);
        showDebugInfo(`è­¦å‘Šæ¶ˆæ¯: ${message}`);
    }

    // éšè—æ‰€æœ‰æç¤º
    function hideAlerts() {
        document.getElementById('successAlert').style.display = 'none';
        document.getElementById('errorAlert').style.display = 'none';
        document.getElementById('infoAlert').style.display = 'none';
        document.getElementById('warningAlert').style.display = 'none';
    }

    // ==================== å·¥å…·å‡½æ•° ====================

    // å®‰å…¨fetchå‡½æ•°
    function secureFetch(url, options = {}) {
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include'
        };

        const finalOptions = {
            ...defaultOptions,
            ...options,
            headers: {
                ...defaultOptions.headers,
                ...(options.headers || {})
            }
        };

        showDebugInfo(`å‘é€è¯·æ±‚åˆ°: ${url}`);
        showDebugInfo(`è¯·æ±‚é€‰é¡¹: ${JSON.stringify(finalOptions)}`);

        return fetch(url, finalOptions);
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // æ ¼å¼åŒ–å­—èŠ‚å¤§å°
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';

        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’è½¬æ¢ä¸ºå¯è¯»æ ¼å¼ï¼‰
    function formatTime(seconds) {
        if (seconds < 60) {
            return `${Math.ceil(seconds)}ç§’`;
        } else if (seconds < 3600) {
            return `${Math.ceil(seconds / 60)}åˆ†é’Ÿ`;
        } else {
            return `${Math.ceil(seconds / 3600)}å°æ—¶`;
        }
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡å™¨çŠ¶æ€ç›‘æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <!-- å¼•å…¥CryptoJSç”¨äºHMACç­¾å -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* åŸæœ‰çš„CSSæ ·å¼ä¿æŒä¸å˜ */
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --primary-color: #4a6ee0;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --border-color: #dee2e6;
            --table-header-bg: #e9ecef;
            --table-row-even: #f8f9fa;
            --table-row-hover: #ececec;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #e9ecef;
            --card-bg: #1e1e1e;
            --primary-color: #6c8dfa;
            --secondary-color: #a0aec0;
            --success-color: #48bb78;
            --warning-color: #ecc94b;
            --danger-color: #f56565;
            --border-color: #2d3748;
            --table-header-bg: #2d3748;
            --table-row-even: #2a2a2a;
            --table-row-hover: #2d2d2d;
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* ç™»å½•å’Œæ³¨å†Œç•Œé¢æ ·å¼ */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--border-color);
        }

        .auth-title {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 600;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }

        .form-input {
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 110, 224, 0.1);
        }

        .form-input.error {
            border-color: var(--danger-color);
        }

        .form-input.success {
            border-color: var(--success-color);
        }

        .form-hint {
            font-size: 12px;
            color: var(--secondary-color);
            margin-top: 4px;
        }

        .form-error {
            font-size: 12px;
            color: var(--danger-color);
            margin-top: 4px;
        }

        .password-strength {
            margin-top: 5px;
            height: 4px;
            border-radius: 2px;
            background-color: var(--border-color);
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: width 0.3s, background-color 0.3s;
        }

        .password-strength.weak .password-strength-bar {
            width: 25%;
            background-color: var(--danger-color);
        }

        .password-strength.fair .password-strength-bar {
            width: 50%;
            background-color: var(--warning-color);
        }

        .password-strength.good .password-strength-bar {
            width: 75%;
            background-color: #ffa500;
        }

        .password-strength.strong .password-strength-bar {
            width: 100%;
            background-color: var(--success-color);
        }

        .auth-button {
            padding: 12px 16px;
            border-radius: 8px;
            border: none;
            background: var(--primary-color);
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .auth-button:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 110, 224, 0.3);
        }

        .auth-button:disabled {
            background: var(--secondary-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .auth-error {
            color: var(--danger-color);
            text-align: center;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 6px;
            display: none;
        }

        .auth-success {
            color: var(--success-color);
            text-align: center;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 6px;
            display: none;
        }

        .auth-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--secondary-color);
        }

        .auth-loading .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 2px solid var(--primary-color);
            animation: spin 1s linear infinite;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: var(--secondary-color);
        }

        .auth-switch a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        /* ç”¨æˆ·ä¿¡æ¯æ ·å¼ */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-left: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .username {
            font-weight: 500;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: var(--secondary-color);
        }

        .logout-button {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-button:hover {
            filter: brightness(1.1);
        }

        /* ä¸»å†…å®¹å®¹å™¨ - ç™»å½•åæ˜¾ç¤º */
        .main-content {
            display: none;
        }

        /* å…¶ä½™æ ·å¼ä¿æŒä¸å˜ */
        h2 {
            text-align: center;
            margin-bottom: 20px;
            padding-top: 20px;
            color: var(--primary-color);
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
            margin-bottom: 240px;
            gap: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            width: calc(50% - 20px);
            border: 1px solid var(--border-color);
        }

        #info {
            font-size: 14px;
            line-height: 1.6;
            padding: 15px;
        }

        .chart {
            height: 300px;
            width: 100%;
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        select, button {
            padding: 10px 16px;
            margin: 5px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
            cursor: pointer;
            outline: none;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            font-weight: 500;
            transition: all 0.2s;
        }

        button:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* çŠ¶æ€è¡¨æ ¼æ ·å¼ */
        .status-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }

        .status-table th, .status-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .status-table th {
            background-color: var(--table-header-bg);
            font-weight: 600;
        }

        .status-table tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        .status-table tr:hover {
            background-color: var(--table-row-hover);
        }

        .status-value {
            font-weight: 500;
            color: var(--primary-color);
        }

        /* åœ¨çº¿ç”¨æˆ·è¡¨æ ¼æ ·å¼ */
        .online-users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
            table-layout: fixed;
            word-wrap: break-word;
        }

        .online-users-table th, .online-users-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .online-users-table th {
            background-color: var(--table-header-bg);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .online-users-table tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        .online-users-table tr:hover {
            background-color: var(--table-row-hover);
        }

        .online-count {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
            text-align: center;
            font-size: 16px;
            padding: 8px;
            background-color: rgba(74, 110, 224, 0.1);
            border-radius: 6px;
        }

        /* ç”¨æˆ·ä¿¡æ¯è¡¨æ ¼å®¹å™¨ */
        .user-table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        /* ç”¨æˆ·ç¦»å¼€åŠ¨ç”» */
        .user-leaving {
            animation: userLeave 0.5s ease-out forwards;
            background-color: rgba(220, 53, 69, 0.1) !important;
        }

        @keyframes userLeave {
            0% {
                opacity: 1;
                max-height: 100px;
            }
            100% {
                opacity: 0;
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
                border-bottom-width: 0;
            }
        }

        /* ç”¨æˆ·åŠ å…¥åŠ¨ç”» */
        .user-joining {
            animation: userJoin 0.5s ease-out;
            background-color: rgba(40, 167, 69, 0.1) !important;
        }

        @keyframes userJoin {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* åˆ·æ–°åŠ¨ç”» */
        .refreshing {
            animation: refreshing 1s infinite;
        }

        @keyframes refreshing {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* å›ºå®šå³ä¸‹è§’åª’ä½“æ¨¡å— */
        #fixedMediaContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            height: 240px;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            background: var(--card-bg);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .media-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.03);
            border-bottom: 1px solid var(--border-color);
        }

        .media-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--primary-color);
        }

        .media-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .media-controls button {
            padding: 6px 10px;
            font-size: 12px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #mediaVolume {
            width: 80px;
        }

        .media-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        #fixedMediaImg,
        #fixedMediaVideo {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .media-zoomed {
            position: fixed !important;
            bottom: 0 !important;
            right: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 10000;
            border-radius: 0 !important;
        }

        .media-zoomed #fixedMediaImg,
        .media-zoomed #fixedMediaVideo {
            max-width: 90%;
            max-height: 90%;
            transform: none;
            cursor: zoom-out;
        }

        .media-zoomed .media-header {
            background: rgba(0, 0, 0, 0.7);
            color: white;
        }

        .media-placeholder {
            color: var(--secondary-color);
            text-align: center;
            padding: 20px;
            font-size: 14px;
        }

        .media-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .media-error {
            color: var(--danger-color);
            text-align: center;
            padding: 20px;
        }

        /* ç§»åŠ¨è®¾å¤‡ç‰¹æ®Šæ ·å¼ */
        .mobile-warning {
            display: none;
            background: var(--warning-color);
            color: #000;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            margin-bottom: 10px;
        }

        /* ç¾è§‚çš„è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .connection-status-container {
            display: flex;
            align-items: center;
            margin-left: 10px;
            position: relative;
        }

        .connection-indicator {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connection-indicator:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            position: relative;
        }

        .status-connected .status-dot {
            background-color: var(--success-color);
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            animation: pulse-green 2s infinite;
        }

        .status-connecting .status-dot {
            background-color: var(--warning-color);
            animation: pulse-orange 2s infinite;
        }

        .status-disconnected .status-dot {
            background-color: var(--danger-color);
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 6px rgba(40, 167, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }

        @keyframes pulse-orange {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        .status-text {
            font-size: 12px;
            font-weight: 500;
        }

        .connection-details {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            width: 200px;
            display: none;
            border: 1px solid var(--border-color);
        }

        .connection-indicator:hover .connection-details {
            display: block;
        }

        .connection-details h4 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: var(--primary-color);
        }

        .connection-details p {
            margin: 4px 0;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
        }

        .connection-details .label {
            color: var(--secondary-color);
        }

        .connection-details .value {
            font-weight: 500;
        }

        .signal-strength {
            display: flex;
            align-items: center;
            margin-top: 8px;
        }

        .signal-bars {
            display: flex;
            align-items: flex-end;
            height: 12px;
            margin-right: 8px;
        }

        .signal-bar {
            width: 3px;
            margin-right: 2px;
            background-color: var(--secondary-color);
        }

        .signal-bar.active {
            background-color: var(--success-color);
        }

        /* è®°ä½æˆ‘é€‰é¡¹æ ·å¼ */
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }


        .signal-bar:nth-child(1) { height: 4px; }
        .signal-bar:nth-child(2) { height: 6px; }
        .signal-bar:nth-child(3) { height: 8px; }
        .signal-bar:nth-child(4) { height: 10px; }

        .signal-text {
            font-size: 10px;
            color: var(--secondary-color);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .card {
                width: 100%;
            }

            #fixedMediaContainer {
                width: 320px;
                height: 200px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
                margin-bottom: 200px;
            }

            #fixedMediaContainer {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
                bottom: 10px;
            }

            .mobile-warning {
                display: block;
            }

            .media-controls {
                flex-wrap: wrap;
                justify-content: center;
            }

            .volume-control {
                order: 3;
                width: 100%;
                justify-content: center;
                margin-top: 5px;
            }

            .connection-status-container {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
                justify-content: center;
            }

            /* ç§»åŠ¨ç«¯è¡¨æ ¼ä¼˜åŒ– */
            .online-users-table {
                font-size: 12px;
            }

            .online-users-table th,
            .online-users-table td {
                padding: 6px 8px;
            }

            .status-table {
                font-size: 12px;
            }

            .status-table th,
            .status-table td {
                padding: 8px 10px;
            }

            /* ç™»å½•è¡¨å•å“åº”å¼ */
            .auth-card {
                padding: 30px 20px;
                margin: 10px;
            }

            .controls {
                flex-direction: column;
            }

            .user-info {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .controls {
                flex-direction: column;
            }

            select, button {
                width: 100%;
                margin: 5px 0;
            }

            #fixedMediaContainer {
                height: 180px;
            }

            /* è¶…å°å±å¹•è¡¨æ ¼ä¼˜åŒ– */
            .online-users-table {
                font-size: 11px;
            }

            .online-users-table th,
            .online-users-table td {
                padding: 4px 6px;
            }

            .status-table {
                font-size: 11px;
            }

            .status-table th,
            .status-table td {
                padding: 6px 8px;
            }

            /* åœ¨è¶…å°å±å¹•ä¸Šéšè—ä¸å¿…è¦çš„åˆ— */
            .hide-on-mobile {
                display: none;
            }
        }

    </style>
</head>
<body data-theme="light">
<!-- ç™»å½•/æ³¨å†Œç•Œé¢ -->
<div id="authContainer" class="auth-container">
    <!-- ç™»å½•å¡ç‰‡ -->
    <div id="loginCard" class="auth-card">
        <div class="auth-title">æœåŠ¡å™¨çŠ¶æ€ç›‘æ§ç³»ç»Ÿ</div>
        <form id="loginForm" class="auth-form">
            <div class="form-group">
                <label class="form-label" for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="password">å¯†ç </label>
                <input type="password" id="password" class="form-input" placeholder="è¯·è¾“å…¥å¯†ç " required>
            </div>
            <div class="remember-me">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">è®°ä½æˆ‘</label>
            </div>
            <button type="submit" class="auth-button" id="loginButton">
                <span id="loginButtonText">ç™»å½•</span>
                <div id="loginLoading" class="auth-loading" style="display: none;">
                    <div class="spinner"></div>
                    <span>ç™»å½•ä¸­...</span>
                </div>
            </button>
            <div id="loginError" class="auth-error">
                ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
            </div>
        </form>
        <div class="auth-switch">
            è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ <a id="showRegister">æ³¨å†Œæ–°è´¦æˆ·</a>
        </div>
        <div style="margin-top: 20px; text-align: center; font-size: 12px; color: var(--secondary-color);">
            é»˜è®¤è´¦å·: admin / admin123
        </div>
    </div>

    <!-- æ³¨å†Œå¡ç‰‡ -->
    <div id="registerCard" class="auth-card" style="display: none;">
        <div class="auth-title">æ³¨å†Œæ–°è´¦æˆ·</div>
        <form id="registerForm" class="auth-form">
            <div class="form-group">
                <label class="form-label" for="regUsername">ç”¨æˆ·å</label>
                <input type="text" id="regUsername" class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                <div class="form-hint">ç”¨æˆ·åé•¿åº¦åº”åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´</div>
                <div class="form-error" id="regUsernameError"></div>
            </div>
            <div class="form-group">
                <label class="form-label" for="regEmail">é‚®ç®±åœ°å€</label>
                <input type="email" id="regEmail" class="form-input" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" required>
                <div class="form-hint">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</div>
                <div class="form-error" id="regEmailError"></div>
            </div>
            <div class="form-group">
                <label class="form-label" for="regPassword">å¯†ç </label>
                <input type="password" id="regPassword" class="form-input" placeholder="è¯·è¾“å…¥å¯†ç " required>
                <div class="form-hint">å¯†ç é•¿åº¦è‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—</div>
                <div class="password-strength" id="passwordStrength">
                    <div class="password-strength-bar"></div>
                </div>
                <div class="form-error" id="regPasswordError"></div>
            </div>
            <div class="form-group">
                <label class="form-label" for="regConfirmPassword">ç¡®è®¤å¯†ç </label>
                <input type="password" id="regConfirmPassword" class="form-input" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
                <div class="form-error" id="regConfirmPasswordError"></div>
            </div>
            <div class="remember-me">
                <input type="checkbox" id="regRememberMe">
                <label for="regRememberMe">è®°ä½æˆ‘</label>
            </div>
            <button type="submit" class="auth-button" id="registerButton">
                <span id="registerButtonText">æ³¨å†Œ</span>
                <div id="registerLoading" class="auth-loading" style="display: none;">
                    <div class="spinner"></div>
                    <span>æ³¨å†Œä¸­...</span>
                </div>
            </button>
            <div id="registerError" class="auth-error">
                æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
            </div>
            <div id="registerSuccess" class="auth-success">
                æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è·³è½¬...
            </div>
        </form>
        <div class="auth-switch">
            å·²æœ‰è´¦æˆ·ï¼Ÿ <a id="showLogin">è¿”å›ç™»å½•</a>
        </div>
    </div>
</div>

<!-- ä¸»å†…å®¹ç•Œé¢ - ç™»å½•åæ˜¾ç¤º -->
<div id="mainContent" class="main-content">
    <!-- å…¶ä½™å†…å®¹ä¿æŒä¸å˜ -->
    <div class="mobile-warning">
        æç¤ºï¼šåœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œè§†é¢‘å¯èƒ½éœ€è¦æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾æŒ‰é’®
    </div>

    <h2>å®æ—¶æœåŠ¡å™¨çŠ¶æ€ç›‘æ§</h2>

    <div class="controls">
        <select id="ifaceSelect">
            <option value="">é€‰æ‹©ç½‘å¡...</option>
        </select>
        <button class="btn btn-secondary" onclick="toggleTheme()">
            ğŸŒ™ åˆ‡æ¢ä¸»é¢˜
        </button>
        <button class="btn" onclick="reconnectWebSocket()" id="reconnectBtn">
            ğŸ”„ é‡æ–°è¿æ¥
        </button>
        <button class="btn" onclick="refreshAccessStats()">
            ğŸ“ˆ åˆ·æ–°ç»Ÿè®¡
        </button>
        <button class="btn" onclick="window.location.href='ebooks.html'">
            ğŸ“š ç”µå­ä¹¦
        </button>
        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <div class="user-info" id="userInfo">
            <div class="user-avatar" id="userAvatar">A</div>
            <div class="user-details">
                <div class="username" id="usernameDisplay">ç®¡ç†å‘˜</div>
                <div class="user-role" id="userRole">ç®¡ç†å‘˜</div>
            </div>
            <button class="logout-button" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>


        <!-- ç¾è§‚çš„è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="connection-status-container">
            <div class="connection-indicator status-disconnected" id="connectionIndicator">
                <div class="status-dot"></div>
                <span class="status-text" id="statusText">å·²æ–­å¼€</span>
                <div class="connection-details">
                    <h4>è¿æ¥çŠ¶æ€</h4>
                    <p><span class="label">çŠ¶æ€:</span> <span class="value" id="detailStatus">å·²æ–­å¼€</span></p>
                    <p><span class="label">ç½‘å¡:</span> <span class="value" id="detailIface">-</span></p>
                    <p><span class="label">é‡è¿æ¬¡æ•°:</span> <span class="value" id="detailReconnect">0</span></p>
                    <p><span class="label">æŒç»­æ—¶é—´:</span> <span class="value" id="detailDuration">-</span></p>
                    <div class="signal-strength">
                        <div class="signal-bars">
                            <div class="signal-bar"></div>
                            <div class="signal-bar"></div>
                            <div class="signal-bar"></div>
                            <div class="signal-bar"></div>
                        </div>
                        <span class="signal-text" id="signalText">ä¿¡å·å¼ºåº¦</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card" id="info">
            <div class="media-loading">
                <div class="spinner"></div>
                <div>ç­‰å¾…æ•°æ®è¿æ¥...</div>
            </div>
        </div>
        <!-- å¢å¼ºçš„åœ¨çº¿ç”¨æˆ·å¡ç‰‡ -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong>åœ¨çº¿ç”¨æˆ·ä¿¡æ¯</strong>
                <span id="lastUpdated" style="font-size: 12px; color: var(--secondary-color);">ä¸Šæ¬¡æ›´æ–°: -</span>
            </div>
            <div id="onlineUsersInfo">
                <div class="online-count">
                    å½“å‰åœ¨çº¿: <span id="onlineCount">0</span> ç”¨æˆ· | <span id="uniqueIpsCount">0</span> ä¸ªç‹¬ç«‹IP
                </div>
                <div class="user-table-container">
                    <table id="onlineUsersTable" class="online-users-table">
                        <thead>
                        <tr>
                            <th>IPåœ°å€</th>
                            <th>è®¿é—®é¡µé¢</th>
                            <th class="hide-on-mobile">è¿æ¥æ—¶é—´</th>
                            <th>ç”¨æˆ·æ ‡è¯†</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- ç”¨æˆ·æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="card"><div id="memChart" class="chart"></div></div>
        <div class="card"><div id="cpuChart" class="chart"></div></div>
        <div class="card"><div id="netChart" class="chart"></div></div>
        <div class="card"><div id="diskChart" class="chart"></div></div>
        <div class="card"><div id="accessChart" class="chart"></div></div>
    </div>

    <!-- å³ä¸‹è§’å›ºå®šä½ç½®åª’ä½“æ¨¡å— -->
    <div id="fixedMediaContainer">
        <div class="media-header">
            <div class="media-title">åª’ä½“å±•ç¤º</div>
            <div class="media-controls">
                <div class="volume-control">
                    <span>éŸ³é‡:</span>
                    <input type="range" id="mediaVolume" min="0" max="1" step="0.1" value="0.5">
                </div>
                <button id="refreshMedia">åˆ·æ–°</button>
                <button id="togglePlayPause" style="display:none;">æš‚åœ</button>
                <button id="zoomMedia">æ”¾å¤§</button>
            </div>
        </div>
        <div class="media-content">
            <img id="fixedMediaImg" style="display:none;" alt="åª’ä½“å›¾ç‰‡">
            <video id="fixedMediaVideo" style="display:none;" loop muted playsinline preload="metadata" alt="åª’ä½“è§†é¢‘"></video>
            <div class="media-placeholder" id="mediaPlaceholder">
                åª’ä½“åŠ è½½ä¸­...
            </div>
        </div>
    </div>
</div>

<script>
    // å…¨å±€å˜é‡
    let theme = 'light';
    let ws = null;
    const baseUrl = "https://wustwu.cn:9000";

    // ç”¨æˆ·è®¤è¯ç›¸å…³å˜é‡
    let currentUser = null;
    let authToken = null;

    // ä¼šè¯ç®¡ç†é…ç½®
    const SESSION_STORAGE_KEY = 'server_monitor_session';
    const LOCAL_STORAGE_KEY = 'server_monitor_remember';
    const SESSION_EXPIRY_DAYS = 30;
    // å®‰å…¨é…ç½® - ä¸æœåŠ¡å™¨ç«¯ä¿æŒä¸€è‡´
    const securityToken = "wustwu_anti_crawler_2024_security_key";
    const signatureTimeout = 30000; // 30ç§’

    // åœ¨çº¿ç”¨æˆ·ç›¸å…³å˜é‡
    let onlineUsersInterval = null;
    let lastOnlineUsers = [];

    // WebSocketé‡è¿ç›¸å…³å˜é‡
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let reconnectTimeout = null;
    let isManualReconnect = false;
    let connectionStartTime = null;
    let currentIface = '';

    // æ£€æµ‹ç§»åŠ¨è®¾å¤‡
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    // é¡µé¢å¯è§æ€§API
    let hidden, visibilityChange;
    if (typeof document.hidden !== "undefined") {
        hidden = "hidden";
        visibilityChange = "visibilitychange";
    } else if (typeof document.msHidden !== "undefined") {
        hidden = "msHidden";
        visibilityChange = "msvisibilitychange";
    } else if (typeof document.webkitHidden !== "undefined") {
        hidden = "webkitHidden";
        visibilityChange = "webkitvisibilitychange";
    }
    // ==================== ä¼šè¯ç®¡ç†åŠŸèƒ½ ====================

    // ä¼šè¯å­˜å‚¨ç®¡ç†
    const SessionManager = {
        // ä¿å­˜ç™»å½•çŠ¶æ€
        saveLoginState: function(user, rememberMe = false) {
            const sessionData = {
                user: user,
                timestamp: Date.now(),
                expiry: Date.now() + (SESSION_EXPIRY_DAYS * 24 * 60 * 60 * 1000) // 30å¤©åè¿‡æœŸ
            };

            if (rememberMe) {
                // é•¿æœŸä¿å­˜åˆ°localStorage
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(sessionData));
                console.log('ç™»å½•çŠ¶æ€å·²ä¿å­˜åˆ°localStorage');
            } else {
                // ä¸´æ—¶ä¿å­˜åˆ°sessionStorage
                sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(sessionData));
                console.log('ç™»å½•çŠ¶æ€å·²ä¿å­˜åˆ°sessionStorage');
            }
        },

        // è·å–ä¿å­˜çš„ç™»å½•çŠ¶æ€
        getSavedLoginState: function() {
            // é¦–å…ˆæ£€æŸ¥sessionStorageï¼ˆä¼šè¯æœŸé—´ï¼‰
            let sessionData = sessionStorage.getItem(SESSION_STORAGE_KEY);
            if (sessionData) {
                console.log('ä»sessionStorageè·å–ç™»å½•çŠ¶æ€');
                return JSON.parse(sessionData);
            }

            // ç„¶åæ£€æŸ¥localStorageï¼ˆé•¿æœŸä¿å­˜ï¼‰
            sessionData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (sessionData) {
                console.log('ä»localStorageè·å–ç™»å½•çŠ¶æ€');
                return JSON.parse(sessionData);
            }

            return null;
        },

        // æ£€æŸ¥ä¼šè¯æ˜¯å¦æœ‰æ•ˆ
        isSessionValid: function(sessionData) {
            if (!sessionData || !sessionData.expiry) {
                return false;
            }

            // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            const isValid = Date.now() < sessionData.expiry;
            console.log('ä¼šè¯æœ‰æ•ˆæ€§æ£€æŸ¥:', isValid ? 'æœ‰æ•ˆ' : 'å·²è¿‡æœŸ');
            return isValid;
        },

        // æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„çŠ¶æ€
        clearAllStates: function() {
            sessionStorage.removeItem(SESSION_STORAGE_KEY);
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            console.log('æ‰€æœ‰ç™»å½•çŠ¶æ€å·²æ¸…é™¤');
        },

        // è·å–ä¿å­˜çš„ç”¨æˆ·åï¼ˆç”¨äºè‡ªåŠ¨å¡«å……ï¼‰
        getSavedUsername: function() {
            const sessionData = this.getSavedLoginState();
            return sessionData && sessionData.user ? sessionData.user.username : null;
        },

        // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†"è®°ä½æˆ‘"
        isRememberMeEnabled: function() {
            return localStorage.getItem(LOCAL_STORAGE_KEY) !== null;
        }
    };

    // ==================== è‡ªåŠ¨ç™»å½•åŠŸèƒ½ ====================

    // æ£€æŸ¥è‡ªåŠ¨ç™»å½•çŠ¶æ€
    function checkAutoLogin() {
        console.log('æ£€æŸ¥è‡ªåŠ¨ç™»å½•çŠ¶æ€...');
        const sessionData = SessionManager.getSavedLoginState();

        if (sessionData && SessionManager.isSessionValid(sessionData)) {
            // ä¼šè¯æœ‰æ•ˆï¼Œå°è¯•è‡ªåŠ¨ç™»å½•
            console.log('æ£€æµ‹åˆ°æœ‰æ•ˆä¼šè¯ï¼Œå°è¯•è‡ªåŠ¨ç™»å½•');
            currentUser = sessionData.user;
            authToken = getCookie('session_id');

            // éªŒè¯ä¼šè¯æœ‰æ•ˆæ€§
            verifySessionValidity()
                .then(isValid => {
                    if (isValid) {
                        console.log('è‡ªåŠ¨ç™»å½•æˆåŠŸ');
                        showMainContent();
                        initApp();
                    } else {
                        // ä¼šè¯æ— æ•ˆï¼Œæ¸…é™¤ä¿å­˜çš„çŠ¶æ€
                        console.log('ä¼šè¯æ— æ•ˆï¼Œæ¸…é™¤ä¿å­˜çš„çŠ¶æ€');
                        SessionManager.clearAllStates();
                        showLogin();
                    }
                })
                .catch(error => {
                    console.error('éªŒè¯ä¼šè¯å¤±è´¥:', error);
                    showLogin();
                });
        } else {
            // æ²¡æœ‰æœ‰æ•ˆä¼šè¯æˆ–ä¼šè¯å·²è¿‡æœŸ
            console.log('æ²¡æœ‰æœ‰æ•ˆä¼šè¯ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢');
            if (sessionData) {
                SessionManager.clearAllStates();
            }
            showLogin();
        }
    }

    // éªŒè¯ä¼šè¯æœ‰æ•ˆæ€§
    function verifySessionValidity() {
        return secureFetch(`${baseUrl}/check-auth`)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Authentication failed');
                }
            })
            .then(data => {
                return data.code === 200;
            })
            .catch(error => {
                console.error('éªŒè¯ä¼šè¯æœ‰æ•ˆæ€§å¤±è´¥:', error);
                return false;
            });
    }

    // ==================== ç”¨æˆ·è®¤è¯åŠŸèƒ½ ====================

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function checkAuthStatus() {
        const sessionId = getCookie('session_id');
        if (!sessionId) {
            checkAutoLogin();
            return;
        }

        // éªŒè¯ä¼šè¯çŠ¶æ€
        secureFetch(`${baseUrl}/check-auth`)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Authentication failed');
                }
            })
            .then(data => {
                if (data.code === 200) {
                    currentUser = data.user;
                    authToken = sessionId;
                    showMainContent();
                    initApp();
                } else {
                    checkAutoLogin();
                }
            })
            .catch(error => {
                console.error('éªŒè¯ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                checkAutoLogin();
            });
    }

    // ç™»å½•å¤„ç†
    function handleLogin(event) {
        event.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const rememberMe = document.getElementById('rememberMe').checked;

        if (!username || !password) {
            showLoginError('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
            return;
        }

        showLoginLoading(true);

        const loginData = {
            username: username,
            password: password
        };

        fetch(`${baseUrl}/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(loginData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Login failed');
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    currentUser = data.user;
                    authToken = getCookie('session_id'); // ä»cookieè·å–session_id

                    // ä¿å­˜ç™»å½•çŠ¶æ€
                    SessionManager.saveLoginState(currentUser, rememberMe);

                    showMainContent();
                    initApp();
                } else {
                    showLoginError(data.message || 'ç™»å½•å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('ç™»å½•é”™è¯¯:', error);
                showLoginError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            })
            .finally(() => {
                showLoginLoading(false);
            });
    }

    // æ³¨å†Œå¤„ç†
    function handleRegister(event) {
        event.preventDefault();

        const username = document.getElementById('regUsername').value;
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;
        const confirmPassword = document.getElementById('regConfirmPassword').value;
        const rememberMe = document.getElementById('regRememberMe').checked;

        // å®¢æˆ·ç«¯éªŒè¯
        if (!validateRegisterForm(username, email, password, confirmPassword)) {
            return;
        }

        showRegisterLoading(true);

        const registerData = {
            username: username,
            email: email,
            password: password
        };

        fetch(`${baseUrl}/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(registerData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Registration failed');
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    // æ³¨å†ŒæˆåŠŸï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å¹¶è‡ªåŠ¨ç™»å½•
                    showRegisterSuccess('æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è‡ªåŠ¨ç™»å½•...');

                    // è‡ªåŠ¨ç™»å½•
                    setTimeout(() => {
                        const loginData = {
                            username: username,
                            password: password
                        };

                        fetch(`${baseUrl}/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(loginData)
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Auto-login failed');
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.code === 200) {
                                    currentUser = data.user;
                                    authToken = getCookie('session_id');

                                    // ä¿å­˜ç™»å½•çŠ¶æ€
                                    SessionManager.saveLoginState(currentUser, rememberMe);

                                    showMainContent();
                                    initApp();
                                } else {
                                    showLogin();
                                }
                            })
                            .catch(error => {
                                console.error('è‡ªåŠ¨ç™»å½•å¤±è´¥:', error);
                                showLogin();
                            });
                    }, 1500);
                } else {
                    showRegisterError(data.message || 'æ³¨å†Œå¤±è´¥');
                }
            })
            .catch(error => {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                showRegisterError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            })
            .finally(() => {
                showRegisterLoading(false);
            });
    }

    // æ³¨å†Œè¡¨å•éªŒè¯
    function validateRegisterForm(username, email, password, confirmPassword) {
        let isValid = true;

        // é‡ç½®é”™è¯¯çŠ¶æ€
        clearRegisterErrors();

        // ç”¨æˆ·åéªŒè¯
        if (username.length < 3 || username.length > 20) {
            document.getElementById('regUsernameError').textContent = 'ç”¨æˆ·åé•¿åº¦åº”åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´';
            document.getElementById('regUsername').classList.add('error');
            isValid = false;
        }

        // é‚®ç®±éªŒè¯
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            document.getElementById('regEmailError').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€';
            document.getElementById('regEmail').classList.add('error');
            isValid = false;
        }

        // å¯†ç éªŒè¯
        const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d).{8,}$/;
        if (!passwordRegex.test(password)) {
            document.getElementById('regPasswordError').textContent = 'å¯†ç é•¿åº¦è‡³å°‘8ä½ï¼Œä¸”å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—';
            document.getElementById('regPassword').classList.add('error');
            isValid = false;
        }

        // ç¡®è®¤å¯†ç éªŒè¯
        if (password !== confirmPassword) {
            document.getElementById('regConfirmPasswordError').textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
            document.getElementById('regConfirmPassword').classList.add('error');
            isValid = false;
        }

        return isValid;
    }

    // æ¸…é™¤æ³¨å†Œè¡¨å•é”™è¯¯
    function clearRegisterErrors() {
        const errorElements = document.querySelectorAll('.form-error');
        errorElements.forEach(el => {
            el.textContent = '';
        });

        const inputElements = document.querySelectorAll('#registerForm .form-input');
        inputElements.forEach(el => {
            el.classList.remove('error');
        });

        document.getElementById('registerError').style.display = 'none';
    }

    // æ˜¾ç¤º/éšè—æ³¨å†ŒåŠ è½½çŠ¶æ€
    function showRegisterLoading(show) {
        const buttonText = document.getElementById('registerButtonText');
        const loadingElement = document.getElementById('registerLoading');
        const registerButton = document.getElementById('registerButton');

        if (show) {
            buttonText.style.display = 'none';
            loadingElement.style.display = 'flex';
            registerButton.disabled = true;
        } else {
            buttonText.style.display = 'block';
            loadingElement.style.display = 'none';
            registerButton.disabled = false;
        }
    }

    // æ˜¾ç¤ºæ³¨å†Œé”™è¯¯
    function showRegisterError(message) {
        const errorElement = document.getElementById('registerError');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
    }

    // æ˜¾ç¤ºæ³¨å†ŒæˆåŠŸ
    function showRegisterSuccess(message) {
        const successElement = document.getElementById('registerSuccess');
        successElement.textContent = message;
        successElement.style.display = 'block';
    }

    // é€€å‡ºç™»å½•
    function logout() {
        secureFetch(`${baseUrl}/logout`, {
            method: 'POST'
        })
            .then(response => {
                if (response.ok) {
                    // æ¸…é™¤æœ¬åœ°çŠ¶æ€
                    currentUser = null;
                    authToken = null;
                    SessionManager.clearAllStates();

                    // æ¸…é™¤WebSocketè¿æ¥
                    if (ws) {
                        ws.close();
                        ws = null;
                    }

                    // æ˜¾ç¤ºç™»å½•ç•Œé¢
                    showLogin();
                }
            })
            .catch(error => {
                console.error('é€€å‡ºç™»å½•é”™è¯¯:', error);
                // å³ä½¿å‡ºé”™ä¹Ÿå¼ºåˆ¶æ˜¾ç¤ºç™»å½•ç•Œé¢
                currentUser = null;
                authToken = null;
                SessionManager.clearAllStates();
                showLogin();
            });
    }

    // æ˜¾ç¤ºç™»å½•ç•Œé¢
    function showLogin() {
        document.getElementById('loginCard').style.display = 'block';
        document.getElementById('registerCard').style.display = 'none';
        document.getElementById('authContainer').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'none';

        // è‡ªåŠ¨å¡«å……ç”¨æˆ·åï¼ˆå¦‚æœä¹‹å‰ä¿å­˜è¿‡ï¼‰
        const savedUsername = SessionManager.getSavedUsername();
        if (savedUsername) {
            document.getElementById('username').value = savedUsername;
            document.getElementById('rememberMe').checked = SessionManager.isRememberMeEnabled();
        }

        // æ¸…é™¤è¡¨å•é”™è¯¯
        document.getElementById('loginForm').reset();
        document.getElementById('loginError').style.display = 'none';
    }

    // æ˜¾ç¤ºæ³¨å†Œç•Œé¢
    function showRegister() {
        document.getElementById('loginCard').style.display = 'none';
        document.getElementById('registerCard').style.display = 'block';
        document.getElementById('authContainer').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'none';

        // æ¸…é™¤è¡¨å•
        document.getElementById('registerForm').reset();
        document.getElementById('registerError').style.display = 'none';
        document.getElementById('registerSuccess').style.display = 'none';
        clearRegisterErrors();
        updatePasswordStrength(0);
    }

    // æ˜¾ç¤ºä¸»å†…å®¹
    function showMainContent() {
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
        if (currentUser) {
            document.getElementById('usernameDisplay').textContent = currentUser.username;
            document.getElementById('userRole').textContent = currentUser.permissions && currentUser.permissions.includes('admin') ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·';
            document.getElementById('userAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
        }
    }

    // æ˜¾ç¤ºç™»å½•é”™è¯¯
    function showLoginError(message) {
        const errorElement = document.getElementById('loginError');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
    }

    // æ˜¾ç¤º/éšè—ç™»å½•åŠ è½½çŠ¶æ€
    function showLoginLoading(show) {
        const buttonText = document.getElementById('loginButtonText');
        const loadingElement = document.getElementById('loginLoading');
        const loginButton = document.getElementById('loginButton');

        if (show) {
            buttonText.style.display = 'none';
            loadingElement.style.display = 'flex';
            loginButton.disabled = true;
        } else {
            buttonText.style.display = 'block';
            loadingElement.style.display = 'none';
            loginButton.disabled = false;
        }
    }

    // å¯†ç å¼ºåº¦æ£€æµ‹
    function updatePasswordStrength(password) {
        const strengthBar = document.querySelector('.password-strength');
        const strengthClasses = ['', 'weak', 'fair', 'good', 'strong'];

        // ç§»é™¤æ‰€æœ‰å¼ºåº¦ç±»
        strengthClasses.forEach(cls => {
            if (cls) strengthBar.classList.remove(cls);
        });

        // è®¡ç®—å¯†ç å¼ºåº¦
        let strength = 0;

        if (password.length > 0) {
            strength = 1; // æœ‰å†…å®¹

            if (password.length >= 8) {
                strength = 2; // é•¿åº¦è¾¾æ ‡

                // æ£€æŸ¥æ˜¯å¦åŒ…å«å­—æ¯å’Œæ•°å­—
                const hasLetter = /[A-Za-z]/.test(password);
                const hasNumber = /\d/.test(password);

                if (hasLetter && hasNumber) {
                    strength = 3; // åŒ…å«å­—æ¯å’Œæ•°å­—

                    // æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—ç¬¦
                    const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
                    if (hasSpecial) {
                        strength = 4; // åŒ…å«ç‰¹æ®Šå­—ç¬¦
                    }
                }
            }
        }

        // æ·»åŠ å¯¹åº”çš„å¼ºåº¦ç±»
        if (strength > 0) {
            strengthBar.classList.add(strengthClasses[strength]);
        }
    }

    // è·å–Cookieå€¼
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // ==================== å®‰å…¨åŠŸèƒ½å‡½æ•° ====================

    // ç”ŸæˆHMACç­¾å
    function generateHMACSignature(data) {
        return CryptoJS.HmacSHA256(data, securityToken).toString(CryptoJS.enc.Hex);
    }

    // ç”Ÿæˆè¯·æ±‚ç­¾å
    function generateRequestSignature(path) {
        const timestamp = Math.floor(Date.now() / 1000).toString();
        const nonce = CryptoJS.lib.WordArray.random(16).toString(CryptoJS.enc.Hex);
        const data = `${timestamp}|${nonce}|${path}|${securityToken}`;
        const signature = generateHMACSignature(data);

        return {
            timestamp: timestamp,
            nonce: nonce,
            signature: signature
        };
    }

    // ç”Ÿæˆå®‰å…¨å¤´éƒ¨
    function generateSecurityHeaders(path) {
        const signatureData = generateRequestSignature(path);

        return {
            'X-Timestamp': signatureData.timestamp,
            'X-Nonce': signatureData.nonce,
            'X-Signature': signatureData.signature,
            'Accept': 'application/json,text/html,*/*',
            'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
            'Accept-Encoding': 'gzip, deflate, br',
            'Connection': 'keep-alive',
            'User-Agent': navigator.userAgent || 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        };
    }

    // å®‰å…¨fetchå‡½æ•°
    function secureFetch(url, options = {}) {
        const path = new URL(url).pathname;
        const securityHeaders = generateSecurityHeaders(path);

        console.log('å®‰å…¨å¤´ä¿¡æ¯:', securityHeaders);

        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                ...securityHeaders
            },
            credentials: 'include' // åŒ…å«cookie
        };

        const finalOptions = {
            ...defaultOptions,
            ...options,
            headers: {
                ...defaultOptions.headers,
                ...(options.headers || {})
            }
        };

        console.log('æœ€ç»ˆè¯·æ±‚å¤´:', finalOptions.headers);

        return fetch(url, finalOptions);
    }
    // åœ¨ä¸»é¡µé¢ä¸­æ·»åŠ ä¸‹è½½é¡µé¢è·³è½¬æŒ‰é’®
    function addDownloadButton() {
        // åœ¨æ§åˆ¶æŒ‰é’®åŒºåŸŸæ·»åŠ ä¸‹è½½æŒ‰é’®
        const controls = document.querySelector('.controls');
        const downloadBtn = document.createElement('button');
        downloadBtn.innerHTML = 'ğŸ”‘ ä¸‹è½½ä»¤ç‰Œ';
        downloadBtn.onclick = function() {
            // ç›´æ¥è·³è½¬åˆ°ä¸‹è½½é¡µé¢ï¼Œè®©ä¸‹è½½é¡µé¢è‡ªå·±å¤„ç†è®¤è¯
            window.location.href = 'download.html';
        };
        controls.appendChild(downloadBtn);
    }

    // è·³è½¬å‰æ£€æŸ¥è®¤è¯çŠ¶æ€
    function checkAuthBeforeRedirect(url) {
        const sessionId = getCookie('session_id');
        if (!sessionId) {
            alert('è¯·å…ˆç™»å½•');
            return;
        }

        // éªŒè¯ä¼šè¯æœ‰æ•ˆæ€§
        secureFetch(`${baseUrl}/check-auth`)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Authentication failed');
                }
            })
            .then(data => {
                if (data.code === 200) {
                    // è®¤è¯é€šè¿‡ï¼Œè·³è½¬åˆ°ç›®æ ‡é¡µé¢
                    window.location.href = url;
                } else {
                    alert('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                }
            })
            .catch(error => {
                console.error('éªŒè¯ä¼šè¯å¤±è´¥:', error);
                alert('è®¤è¯æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
            });
    }

    // åœ¨é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨
    document.addEventListener('DOMContentLoaded', function() {
        addDownloadButton();
    });
    // ==================== åŸæœ‰åŠŸèƒ½å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰ ====================

    // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
    function updateConnectionStatus(status, text) {
        const indicator = document.getElementById('connectionIndicator');
        const statusText = document.getElementById('statusText');
        const detailStatus = document.getElementById('detailStatus');

        // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
        indicator.classList.remove('status-connected', 'status-connecting', 'status-disconnected');

        // æ·»åŠ æ–°çŠ¶æ€ç±»
        indicator.classList.add(`status-${status}`);
        statusText.textContent = text;
        detailStatus.textContent = text;

        // æ›´æ–°ä¿¡å·å¼ºåº¦æ˜¾ç¤º
        updateSignalStrength(status);

        // æ›´æ–°è¿æ¥æŒç»­æ—¶é—´
        if (status === 'connected') {
            connectionStartTime = new Date();
            startConnectionTimer();
        } else {
            stopConnectionTimer();
        }

        // æ›´æ–°è¯¦ç»†ä¿¡æ¯
        document.getElementById('detailIface').textContent = currentIface || '-';
        document.getElementById('detailReconnect').textContent = reconnectAttempts;
    }

    // æ›´æ–°ä¿¡å·å¼ºåº¦æ˜¾ç¤º
    function updateSignalStrength(status) {
        const bars = document.querySelectorAll('.signal-bar');
        const signalText = document.getElementById('signalText');

        bars.forEach(bar => bar.classList.remove('active'));

        if (status === 'connected') {
            // æ¨¡æ‹Ÿä¿¡å·å¼ºåº¦ï¼ˆéšæœºå€¼ï¼‰
            const strength = Math.floor(Math.random() * 4) + 1;
            for (let i = 0; i < strength; i++) {
                bars[i].classList.add('active');
            }

            // è®¾ç½®ä¿¡å·æ–‡æœ¬
            const strengths = ['å¼±', 'ä¸€èˆ¬', 'è‰¯å¥½', 'ä¼˜ç§€'];
            signalText.textContent = `ä¿¡å·: ${strengths[strength - 1]}`;
        } else {
            signalText.textContent = 'ä¿¡å·: æ— ';
        }
    }

    // å¯åŠ¨è¿æ¥è®¡æ—¶å™¨
    function startConnectionTimer() {
        stopConnectionTimer(); // ç¡®ä¿æ²¡æœ‰å…¶ä»–è®¡æ—¶å™¨è¿è¡Œ

        // æ¯ç§’æ›´æ–°è¿æ¥æŒç»­æ—¶é—´
        onlineUsersInterval = setInterval(() => {
            if (connectionStartTime) {
                const duration = Math.floor((new Date() - connectionStartTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                document.getElementById('detailDuration').textContent =
                    `${minutes}åˆ†${seconds}ç§’`;
            }
        }, 1000);
    }

    // åœæ­¢è¿æ¥è®¡æ—¶å™¨
    function stopConnectionTimer() {
        if (onlineUsersInterval) {
            clearInterval(onlineUsersInterval);
            onlineUsersInterval = null;
        }
    }

    // åˆå§‹åŒ–åº”ç”¨
    function initApp() {
        // é¦–å…ˆæ£€æŸ¥å¹¶è®¾ç½®ä¸»é¢˜
        checkAndSetTheme();

        initCharts();
        loadInterfaces();
        setupMediaControls();
        loadFixedMedia();
        refreshAccessStats();

        // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬
        document.addEventListener(visibilityChange, handleVisibilityChange, false);

        // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ï¼Œæ·»åŠ ç‰¹æ®Šå¤„ç†
        if (isMobile) {
            console.log("ç§»åŠ¨è®¾å¤‡æ£€æµ‹ï¼Œå¯ç”¨ç‰¹æ®Šå¤„ç†");
        }

        // è®¾ç½®å®šæ—¶æ£€æŸ¥ä¸»é¢˜ï¼ˆæ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
        setInterval(checkAndSetTheme, 5 * 60 * 1000);
    }

    // æ£€æŸ¥å¹¶è®¾ç½®ä¸»é¢˜
    function checkAndSetTheme() {
        // æ£€æŸ¥æ˜¯å¦æœ‰æ‰‹åŠ¨è®¾ç½®çš„ä¸»é¢˜åå¥½
        const manualTheme = localStorage.getItem('manualTheme');

        if (manualTheme) {
            // å¦‚æœç”¨æˆ·æ‰‹åŠ¨è®¾ç½®è¿‡ä¸»é¢˜ï¼Œä½¿ç”¨æ‰‹åŠ¨è®¾ç½®
            setTheme(manualTheme, false); // falseè¡¨ç¤ºè¿™æ˜¯æ‰‹åŠ¨è®¾ç½®ï¼Œä¸éœ€è¦ä¿å­˜
        } else {
            // æ ¹æ®æ—¶é—´è‡ªåŠ¨è®¾ç½®ä¸»é¢˜ï¼ˆæ™šä¸Š18ç‚¹åˆ°æ—©ä¸Š6ç‚¹ä¸ºæš—é»‘æ¨¡å¼ï¼‰
            const hour = new Date().getHours();
            const isNightTime = hour >= 18 || hour < 6;
            setTheme(isNightTime ? 'dark' : 'light', false);
        }
    }

    // è®¾ç½®ä¸»é¢˜
    function setTheme(newTheme, isManual = true) {
        theme = newTheme;
        document.body.setAttribute('data-theme', theme);

        // å¦‚æœæ˜¯æ‰‹åŠ¨è®¾ç½®ï¼Œä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        if (isManual) {
            localStorage.setItem('manualTheme', theme);
        }

        // é‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥é€‚åº”ä¸»é¢˜å˜åŒ–
        setTimeout(() => {
            if (cpuChart && memChart && netChart && diskChart && accessChart) {
                cpuChart.resize();
                memChart.resize();
                netChart.resize();
                diskChart.resize();
                accessChart.resize();
            }
        }, 300);
    }

    // åˆ‡æ¢ä¸»é¢˜
    function toggleTheme() {
        const newTheme = theme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
    }

    // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
    function handleVisibilityChange() {
        if (!document[hidden]) {
            // é¡µé¢å˜ä¸ºå¯è§çŠ¶æ€
            console.log("é¡µé¢å˜ä¸ºå¯è§ï¼Œåˆ·æ–°å›¾è¡¨å’Œæ•°æ®");

            // é‡æ–°è°ƒæ•´å›¾è¡¨å¤§å°
            setTimeout(() => {
                if (cpuChart && memChart && netChart && diskChart && accessChart) {
                    cpuChart.resize();
                    memChart.resize();
                    netChart.resize();
                    diskChart.resize();
                    accessChart.resize();
                }
            }, 100);

            // æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.log("WebSocketè¿æ¥å·²æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥");
                reconnectWebSocket();
            }

            // åˆ·æ–°è®¿é—®ç»Ÿè®¡æ•°æ®
            refreshAccessStats();

            // åˆ·æ–°åª’ä½“
            loadFixedMedia();

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ä¸»é¢˜ï¼ˆä¾‹å¦‚ä»ç™½å¤©è¿›å…¥å¤œæ™šï¼‰
            checkAndSetTheme();
        }
    }

    // æ›´æ–°åœ¨çº¿ç”¨æˆ·æ˜¾ç¤º
    function updateOnlineUsersDisplay(data) {
        if (!data || typeof data !== 'object') {
            document.getElementById('onlineUsersInfo').innerHTML = `
                    <div class="media-error">
                        æ— æ•ˆçš„åœ¨çº¿ç”¨æˆ·æ•°æ®
                    </div>
                `;
            return;
        }

        const onlineCount = data.online_count || 0;
        const uniqueIps = data.unique_ips || [];
        const onlineUsers = data.online_users || [];

        // æ›´æ–°è®¡æ•°æ˜¾ç¤º
        document.getElementById('onlineCount').textContent = onlineCount;
        document.getElementById('uniqueIpsCount').textContent = uniqueIps.length;

        // æ›´æ–°è¡¨æ ¼
        updateOnlineUsersTable(onlineUsers);

        document.getElementById('lastUpdated').textContent = `ä¸Šæ¬¡æ›´æ–°: ${new Date().toLocaleTimeString()}`;
    }

    // æ›´æ–°åœ¨çº¿ç”¨æˆ·è¡¨æ ¼
    function updateOnlineUsersTable(users) {
        const tableBody = document.querySelector('#onlineUsersTable tbody');
        const currentUsers = Array.from(tableBody.querySelectorAll('tr')).map(row => row.getAttribute('data-ip'));
        const newUsers = users.map(user => user.ip);

        // æ‰¾å‡ºç¦»å¼€çš„ç”¨æˆ·
        currentUsers.forEach(ip => {
            if (!newUsers.includes(ip)) {
                const row = tableBody.querySelector(`tr[data-ip="${ip}"]`);
                if (row) {
                    row.classList.add('user-leaving');
                    // åŠ¨ç”»ç»“æŸåç§»é™¤è¡Œ
                    setTimeout(() => {
                        if (row.parentNode) {
                            row.parentNode.removeChild(row);
                        }
                    }, 500);
                }
            }
        });

        // æ‰¾å‡ºæ–°åŠ å…¥çš„ç”¨æˆ·å¹¶æ›´æ–°ç°æœ‰ç”¨æˆ·
        users.forEach(user => {
            const existingRow = tableBody.querySelector(`tr[data-ip="${user.ip}"]`);

            if (existingRow) {
                // æ›´æ–°ç°æœ‰ç”¨æˆ·ä¿¡æ¯
                updateUserRow(existingRow, user);
            } else {
                // æ·»åŠ æ–°ç”¨æˆ·è¡Œ
                const newRow = createUserRow(user);
                newRow.classList.add('user-joining');
                tableBody.appendChild(newRow);

                // åŠ¨ç”»ç»“æŸåç§»é™¤åŠ å…¥åŠ¨ç”»ç±»
                setTimeout(() => {
                    newRow.classList.remove('user-joining');
                }, 500);
            }
        });
    }

    // åˆ›å»ºç”¨æˆ·è¡Œ
    function createUserRow(user) {
        const row = document.createElement('tr');
        row.setAttribute('data-ip', user.ip);

        row.innerHTML = `
                <td>${user.ip || 'N/A'}</td>
                <td>${user.page || 'N/A'}</td>
                <td class="hide-on-mobile">${user.since || 'N/A'}</td>
                <td>${user.user_agent || 'N/A'}</td>
            `;

        return row;
    }

    // æ›´æ–°ç”¨æˆ·è¡Œ
    function updateUserRow(row, user) {
        const cells = row.cells;
        if (cells.length >= 5) {
            cells[0].textContent = user.ip || 'N/A';
            cells[1].textContent = user.page || 'N/A';
            cells[2].textContent = user.since || 'N/A';
            cells[3].textContent = user.user_agent || 'N/A';
        }
    }

    // è®¾ç½®åª’ä½“æ§åˆ¶
    function setupMediaControls() {
        // éŸ³é‡æ§åˆ¶
        const volumeControl = document.getElementById('mediaVolume');
        volumeControl.addEventListener('input', function() {
            const video = document.getElementById('fixedMediaVideo');
            if (video) {
                video.volume = this.value;
            }
        });

        // åˆ·æ–°åª’ä½“æŒ‰é’®
        document.getElementById('refreshMedia').addEventListener('click', loadFixedMedia);

        // æ’­æ”¾/æš‚åœæŒ‰é’®
        document.getElementById('togglePlayPause').addEventListener('click', function() {
            const video = document.getElementById('fixedMediaVideo');
            if (video && video.style.display === 'block') {
                if (video.paused) {
                    // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œå¿…é¡»é€šè¿‡ç”¨æˆ·æ‰‹åŠ¿è§¦å‘æ’­æ”¾
                    const playPromise = video.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            this.textContent = 'æš‚åœ';
                        }).catch(error => {
                            console.log('æ’­æ”¾è¢«é˜»æ­¢:', error);
                            // æ˜¾ç¤ºæç¤ºï¼Œéœ€è¦ç”¨æˆ·äº¤äº’
                            alert('è¯·åœ¨è§†é¢‘ä¸Šç‚¹å‡»ä»¥å¼€å§‹æ’­æ”¾');
                        });
                    }
                } else {
                    video.pause();
                    this.textContent = 'æ’­æ”¾';
                }
            }
        });

        // æ”¾å¤§/ç¼©å°æŒ‰é’®
        document.getElementById('zoomMedia').addEventListener('click', function() {
            const mediaContainer = document.getElementById('fixedMediaContainer');
            if (mediaContainer.classList.contains('media-zoomed')) {
                mediaContainer.classList.remove('media-zoomed');
                this.textContent = 'æ”¾å¤§';
            } else {
                mediaContainer.classList.add('media-zoomed');
                this.textContent = 'ç¼©å°';
            }
        });

        // åŒå‡»åª’ä½“æ”¾å¤§/ç¼©å°
        const mediaContainer = document.getElementById('fixedMediaContainer');
        mediaContainer.addEventListener('dblclick', function() {
            const zoomBtn = document.getElementById('zoomMedia');
            if (this.classList.contains('media-zoomed')) {
                this.classList.remove('media-zoomed');
                zoomBtn.textContent = 'æ”¾å¤§';
            } else {
                this.classList.add('media-zoomed');
                zoomBtn.textContent = 'ç¼©å°';
            }
        });

        // è§†é¢‘å…ƒç´ çš„äº‹ä»¶ç›‘å¬
        const video = document.getElementById('fixedMediaVideo');
        if (video) {
            video.addEventListener('play', function() {
                document.getElementById('togglePlayPause').textContent = 'æš‚åœ';
            });

            video.addEventListener('pause', function() {
                document.getElementById('togglePlayPause').textContent = 'æ’­æ”¾';
            });

            video.addEventListener('ended', function() {
                document.getElementById('togglePlayPause').textContent = 'æ’­æ”¾';
            });

            // ç§»åŠ¨è®¾å¤‡ä¸Šæ·»åŠ ç‚¹å‡»æ’­æ”¾æ”¯æŒ
            if (isMobile) {
                video.addEventListener('click', function() {
                    if (video.paused) {
                        video.play().then(() => {
                            console.log("è§†é¢‘å¼€å§‹æ’­æ”¾");
                        }).catch(e => {
                            console.log("æ’­æ”¾å¤±è´¥ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’", e);
                        });
                    }
                });
            }
        }
    }

    // è·å–ç½‘å¡åˆ—è¡¨
    function loadInterfaces() {
        secureFetch(`${baseUrl}/status-ifaces`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–ç½‘å¡åˆ—è¡¨å¤±è´¥: ' + response.status);
                }
                return response.json();
            })
            .then(ifaces => {
                const sel = document.getElementById('ifaceSelect');
                sel.innerHTML = '<option value="">é€‰æ‹©ç½‘å¡...</option>';

                ifaces.forEach(i => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = i;
                    sel.appendChild(opt);
                });

                if (ifaces.length > 0) {
                    currentIface = ifaces[1];
                    startWebSocket(ifaces[1]);
                    sel.value = ifaces[1];
                }
            })
            .catch(error => {
                console.error('è·å–ç½‘å¡åˆ—è¡¨é”™è¯¯:', error);
                // å°è¯•ä½¿ç”¨é»˜è®¤ç½‘å¡
                currentIface = 'eth4';
                startWebSocket('eth4');
            });

        // ç½‘å¡é€‰æ‹©å˜åŒ–äº‹ä»¶
        document.getElementById('ifaceSelect').addEventListener('change', function() {
            if (this.value) {
                currentIface = this.value;
                startWebSocket(this.value);
            }
        });
    }

    // å¯åŠ¨WebSocketè¿æ¥
    function startWebSocket(iface) {
        // æ¸…é™¤ä¹‹å‰çš„é‡è¿å®šæ—¶å™¨
        if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = null;
        }

        if (ws) {
            // å¦‚æœå·²æœ‰è¿æ¥ï¼Œå…ˆå…³é—­å®ƒ
            ws.onclose = null; // é¿å…è§¦å‘é‡è¿é€»è¾‘
            ws.close();
        }

        try {
            updateConnectionStatus('connecting', 'è¿æ¥ä¸­...');

            // ç”ŸæˆWebSocketå®‰å…¨å‚æ•°
            const signatureData = generateRequestSignature('/ws');

            // ä½¿ç”¨baseUrlæ„å»ºWebSocketè¿æ¥ï¼Œæ·»åŠ å®‰å…¨å‚æ•°
            const wsUrl = `wss://${baseUrl.split('//')[1]}/ws?iface=${iface}&timestamp=${signatureData.timestamp}&nonce=${signatureData.nonce}&signature=${signatureData.signature}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                updateConnectionStatus('connected', 'å·²è¿æ¥');
                reconnectAttempts = 0; // é‡ç½®é‡è¿å°è¯•æ¬¡æ•°
                isManualReconnect = false;
            };

            ws.onmessage = function(e) {
                try {
                    const data = JSON.parse(e.data);
                    updateCharts(data);
                    updateStatusTable(data);
                    // æ›´æ–°åœ¨çº¿ç”¨æˆ·ä¿¡æ¯
                    updateOnlineUsersDisplay(data);
                } catch (error) {
                    console.error('è§£æWebSocketæ•°æ®é”™è¯¯:', error, e.data);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                updateConnectionStatus('disconnected', 'è¿æ¥é”™è¯¯');
            };

            ws.onclose = function(e) {
                console.log('WebSocketè¿æ¥å…³é—­:', e.code, e.reason);
                updateConnectionStatus('disconnected', 'å·²æ–­å¼€');

                // å¦‚æœä¸æ˜¯æ‰‹åŠ¨é‡è¿ï¼Œå¹¶ä¸”é¡µé¢å¯è§ï¼Œå°è¯•è‡ªåŠ¨é‡è¿
                if (!isManualReconnect && !document[hidden] && reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const delay = Math.min(3000 * reconnectAttempts, 15000); // æŒ‡æ•°é€€é¿ç­–ç•¥ï¼Œæœ€å¤š15ç§’
                    console.log(`å°†åœ¨ ${delay/1000} ç§’åå°è¯•ç¬¬ ${reconnectAttempts} æ¬¡é‡è¿`);

                    reconnectTimeout = setTimeout(() => {
                        startWebSocket(iface);
                    }, delay);
                }
            };
        } catch (error) {
            console.error('åˆ›å»ºWebSocketé”™è¯¯:', error);
            updateConnectionStatus('disconnected', 'è¿æ¥å¤±è´¥');
        }
    }

    // é‡æ–°è¿æ¥WebSocket
    function reconnectWebSocket() {
        const iface = document.getElementById('ifaceSelect').value;
        if (iface) {
            isManualReconnect = true;
            reconnectAttempts = 0; // é‡ç½®é‡è¿è®¡æ•°
            startWebSocket(iface);
        } else {
            // å¦‚æœæ²¡æœ‰é€‰æ‹©ç½‘å¡ï¼Œå°è¯•é‡æ–°åŠ è½½ç½‘å¡åˆ—è¡¨
            loadInterfaces();
        }
    }

    // åˆå§‹åŒ–EChartså›¾è¡¨
    let cpuChart, memChart, netChart, diskChart, accessChart;

    function initCharts() {
        cpuChart = echarts.init(document.getElementById('cpuChart'));
        memChart = echarts.init(document.getElementById('memChart'));
        netChart = echarts.init(document.getElementById('netChart'));
        diskChart = echarts.init(document.getElementById('diskChart'));
        accessChart = echarts.init(document.getElementById('accessChart'));

        const chartOption = (title, names, colors) => ({
            title: {
                text: title,
                left: 'center',
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: [],
                axisLine: { lineStyle: { color: 'var(--text-color)' } }
            },
            yAxis: {
                type: 'value',
                axisLine: { lineStyle: { color: 'var(--text-color)' } }
            },
            series: names.map((name, index) => ({
                name: name,
                type: 'line',
                smooth: true,
                itemStyle: {
                    color: colors ? colors[index] : undefined
                },
                lineStyle: {
                    width: 2
                },
                data: []
            })),
            textStyle: { color: 'var(--text-color)' }
        });

        const cpuOpt = chartOption('CPU ä½¿ç”¨ç‡ (%)', ['CPUä½¿ç”¨ç‡'], ['#5470c6']);
        const memOpt = chartOption('å†…å­˜ä½¿ç”¨ç‡ (%)', ['å†…å­˜ä½¿ç”¨ç‡'], ['#91cc75']);
        const netOpt = chartOption('ç½‘ç»œé€Ÿç‡ (KB/s)', ['ä¸Šä¼ ', 'ä¸‹è½½'], ['#fac858', '#ee6666']);
        const diskOpt = chartOption('ç£ç›˜ I/O (KB/s)', ['è¯»å–', 'å†™å…¥'], ['#73c0de', '#3ba272']);

        // è®¿é—®ç»Ÿè®¡å›¾è¡¨ä½¿ç”¨æŸ±çŠ¶å›¾
        const accessOpt = {
            title: {
                text: 'è®¿é—®ç»Ÿè®¡',
                left: 'center'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: [],
                axisLine: { lineStyle: { color: 'var(--text-color)' } }
            },
            yAxis: {
                type: 'value',
                axisLine: { lineStyle: { color: 'var(--text-color)' } }
            },
            series: [{
                name: 'è®¿é—®é‡',
                type: 'bar',
                itemStyle: {
                    color: '#5470c6'
                },
                data: []
            }],
            textStyle: { color: 'var(--text-color)' }
        };

        cpuChart.setOption(cpuOpt);
        memChart.setOption(memOpt);
        netChart.setOption(netOpt);
        diskChart.setOption(diskOpt);
        accessChart.setOption(accessOpt);

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°è°ƒæ•´å›¾è¡¨å¤§å°
        window.addEventListener('resize', function() {
            cpuChart.resize();
            memChart.resize();
            netChart.resize();
            diskChart.resize();
            accessChart.resize();
        });
    }

    // æ›´æ–°å›¾è¡¨æ•°æ®
    const labels = [];
    const maxDataPoints = 20;

    function updateCharts(data) {
        if (!data || typeof data !== 'object') {
            console.error('æ— æ•ˆçš„æ•°æ®æ ¼å¼:', data);
            return;
        }

        const time = new Date().toLocaleTimeString();

        // é™åˆ¶æ•°æ®ç‚¹æ•°é‡
        if (labels.length >= maxDataPoints) {
            labels.shift();
            cpuChart.getOption().series[0].data.shift();
            memChart.getOption().series[0].data.shift();
            netChart.getOption().series[0].data.shift();
            netChart.getOption().series[1].data.shift();
            diskChart.getOption().series[0].data.shift();
            diskChart.getOption().series[1].data.shift();
        }

        labels.push(time);

        // æ›´æ–°CPUå›¾è¡¨
        const cpuUsage = parseFloat(data.cpu_usage || 0);
        cpuChart.setOption({
            xAxis: { data: labels },
            series: [{ data: [...cpuChart.getOption().series[0].data, cpuUsage.toFixed(2)] }]
        });

        // æ›´æ–°å†…å­˜å›¾è¡¨
        const memUsage = parseFloat(data.memory_usage || 0);
        memChart.setOption({
            xAxis: { data: labels },
            series: [{ data: [...memChart.getOption().series[0].data, memUsage.toFixed(2)] }]
        });

        // æ›´æ–°ç½‘ç»œå›¾è¡¨
        const uploadSpeed = parseFloat(data.upload_speed || 0);
        const downloadSpeed = parseFloat(data.download_speed || 0);
        netChart.setOption({
            xAxis: { data: labels },
            series: [
                { data: [...netChart.getOption().series[0].data, uploadSpeed.toFixed(2)] },
                { data: [...netChart.getOption().series[1].data, downloadSpeed.toFixed(2)] }
            ]
        });

        // æ›´æ–°ç£ç›˜å›¾è¡¨
        const readSpeed = parseFloat(data.read_speed || 0);
        const writeSpeed = parseFloat(data.write_speed || 0);
        diskChart.setOption({
            xAxis: { data: labels },
            series: [
                { data: [...diskChart.getOption().series[0].data, readSpeed.toFixed(2)] },
                { data: [...diskChart.getOption().series[1].data, writeSpeed.toFixed(2)] }
            ]
        });
    }

    // æ›´æ–°çŠ¶æ€è¡¨æ ¼
    function updateStatusTable(data) {
        const cpuUsage = parseFloat(data.cpu_usage || 0);
        const memUsage = parseFloat(data.memory_usage || 0);
        const uploadSpeed = parseFloat(data.upload_speed || 0);
        const downloadSpeed = parseFloat(data.download_speed || 0);
        const readSpeed = parseFloat(data.read_speed || 0);
        const writeSpeed = parseFloat(data.write_speed || 0);

        document.getElementById('info').innerHTML = `
                   <strong>æœåŠ¡å™¨çŠ¶æ€ä¿¡æ¯</strong>
                <table class="status-table">
                    <tr>
                        <th>æŒ‡æ ‡</th>
                        <th>å€¼</th>
                        <th>æŒ‡æ ‡</th>
                        <th>å€¼</th>
                    </tr>
                    <tr>
                        <td>ä¸»æœºå</td>
                        <td class="status-value">${data.hostname || 'N/A'}</td>
                        <td>æ“ä½œç³»ç»Ÿ</td>
                        <td class="status-value">${data.os || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td>å¹³å°</td>
                        <td class="status-value">${data.platform || 'N/A'}</td>
                        <td>å†…æ ¸ç‰ˆæœ¬</td>
                        <td class="status-value">${data.kernel_version || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td>ç³»ç»Ÿæ¶æ„</td>
                        <td class="status-value">${data.architecture || 'N/A'}</td>
                        <td>è¿è¡Œæ—¶é—´</td>
                        <td class="status-value">${data.uptime || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td>CPUä½¿ç”¨ç‡</td>
                        <td class="status-value">${cpuUsage.toFixed(2)}%</td>
                        <td>å†…å­˜ä½¿ç”¨ç‡</td>
                        <td class="status-value">${memUsage.toFixed(2)}%</td>
                    </tr>
                    <tr>
                        <td>å†…å­˜æ€»é‡</td>
                        <td class="status-value">${data.memory_total || 'N/A'} MB</td>
                        <td>ç£ç›˜ä½¿ç”¨ç‡</td>
                        <td class="status-value">${data.disk_usage ? parseFloat(data.disk_usage).toFixed(2) : 'N/A'}%</td>
                    </tr>
                    <tr>
                        <td>ç£ç›˜æ€»é‡</td>
                        <td class="status-value">${data.disk_total || 'N/A'} GB</td>
                        <td>ä¸Šä¼ é€Ÿåº¦</td>
                        <td class="status-value">${uploadSpeed.toFixed(2)} KB/s</td>
                    </tr>
                    <tr>
                        <td>ä¸‹è½½é€Ÿåº¦</td>
                        <td class="status-value">${downloadSpeed.toFixed(2)} KB/s</td>
                        <td>ç£ç›˜è¯»å–</td>
                        <td class="status-value">${readSpeed.toFixed(2)} KB/s</td>
                    </tr>
                    <tr>
                        <td>ç£ç›˜å†™å…¥</td>
                        <td class="status-value">${writeSpeed.toFixed(2)} KB/s</td>
                        <td>ç³»ç»Ÿè´Ÿè½½</td>
                        <td class="status-value">${data.load1 || 'N/A'}, ${data.load5 || 'N/A'}, ${data.load15 || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td>ä¸‹è½½æ€»æµé‡</td>
                        <td class="status-value">${data.total_download || 'N/A'}</td>
                        <td>ä¸Šä¼ æ€»æµé‡</td>
                        <td class="status-value">${data.total_upload || 'N/A'}</td>
                    </tr>
                </table>
            `;
    }

    // è·å–è®¿é—®ç»Ÿè®¡æ•°æ®å¹¶æ›´æ–°å›¾è¡¨
    function refreshAccessStats() {
        secureFetch(`${baseUrl}/access-stats`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–è®¿é—®ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                updateAccessChart(data);
            })
            .catch(error => {
                console.error('è·å–è®¿é—®ç»Ÿè®¡æ•°æ®é”™è¯¯:', error);
            });
    }

    // æ›´æ–°è®¿é—®ç»Ÿè®¡å›¾è¡¨
    function updateAccessChart(data) {
        if (!data || !data.daily_visits) {
            console.error('æ— æ•ˆçš„è®¿é—®ç»Ÿè®¡æ•°æ®:', data);
            return;
        }

        // å‡†å¤‡æ•°æ®
        const dates = Object.keys(data.daily_visits).reverse();
        const visits = dates.map(date => data.daily_visits[date]);

        // æ›´æ–°å›¾è¡¨
        accessChart.setOption({
            xAxis: {
                data: dates
            },
            series: [{
                data: visits
            }]
        });
    }

    // å›ºå®šä½ç½®åª’ä½“æ¨¡å—
    function loadFixedMedia() {
        const img = document.getElementById("fixedMediaImg");
        const video = document.getElementById("fixedMediaVideo");
        const placeholder = document.getElementById("mediaPlaceholder");
        const toggleBtn = document.getElementById("togglePlayPause");
        if (!video.paused) {
            video.pause();
        }

        video.removeAttribute('src');  // æ¸…ç©ºè§†é¢‘åœ°å€
        video.load();  // é‡ç½®è§†é¢‘

        img.style.display = "none";
        video.style.display = "none";
        toggleBtn.style.display = "none";
        placeholder.style.display = "block";
        placeholder.className = "media-loading";
        placeholder.innerHTML = '<div class="spinner"></div><div>åŠ è½½åª’ä½“ä¸­...</div>';
        video.addEventListener('loadeddata', function() {
            if (video.paused) {
                video.currentTime = 0; // ç¡®ä¿æ˜¾ç¤ºç¬¬ä¸€å¸§
            }
        });

        secureFetch(`${baseUrl}/random-media`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–åª’ä½“å¤±è´¥: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                const src = data.src;

                if (!src) {
                    placeholder.className = "media-placeholder";
                    placeholder.textContent = "æ— å¯ç”¨åª’ä½“";
                    return;
                }

                const ext = src.split('.').pop().toLowerCase();

                if (ext === "mp4" || ext === "webm" || ext === "mov") {
                    img.style.display = "none";
                    video.src = src;
                    video.style.display = "block";
                    video.volume = document.getElementById('mediaVolume').value;

                    // ç§»åŠ¨è®¾å¤‡ä¸Šé»˜è®¤é™éŸ³ï¼Œä»¥é¿å…è‡ªåŠ¨æ’­æ”¾é—®é¢˜
                    if (isMobile) {
                        video.muted = true;
                        video.setAttribute('muted', '');
                        video.setAttribute('playsinline', '');
                        video.setAttribute('webkit-playsinline', '');
                    } else {
                        video.muted = false;
                    }

                    // è®¾ç½®è§†é¢‘äº‹ä»¶
                    video.onloadeddata = function() {
                        placeholder.style.display = "none";
                        toggleBtn.style.display = "block";
                        toggleBtn.textContent = video.paused ? "æ’­æ”¾" : "æš‚åœ";

                        // éç§»åŠ¨è®¾å¤‡å°è¯•è‡ªåŠ¨æ’­æ”¾
                        if (!isMobile) {
                            const playPromise = video.play();
                            if (playPromise !== undefined) {
                                playPromise.then(() => {
                                    toggleBtn.textContent = 'æš‚åœ';
                                }).catch(e => {
                                    console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:', e);
                                    toggleBtn.textContent = 'æ’­æ”¾';
                                });
                            }
                        } else {
                            // ç§»åŠ¨è®¾å¤‡ä¸Šæ˜¾ç¤ºæç¤º
                            toggleBtn.textContent = 'æ’­æ”¾';
                        }
                    };

                    video.onerror = function(e){
                        console.error("è§†é¢‘åŠ è½½é”™è¯¯:", e, src);
                        placeholder.className='media-error';
                        placeholder.textContent='è§†é¢‘åŠ è½½å¤±è´¥';
                        video.style.display='none';
                        toggleBtn.style.display='none';
                    };
                } else {
                    video.style.display = "none";
                    toggleBtn.style.display = "none";
                    img.src = src;
                    img.style.display = "block";
                    placeholder.style.display = "none";

                    img.onerror = function() {
                        img.style.display = "none";
                        placeholder.className = "media-error";
                        placeholder.textContent = "å›¾ç‰‡åŠ è½½å¤±è´¥";
                        placeholder.style.display = "block";
                    };
                }
            })
            .catch(error => {
                console.error("åŠ è½½éšæœºåª’ä½“å¤±è´¥:", error);
                placeholder.className = "media-error";
                placeholder.textContent = "åª’ä½“åŠ è½½å¤±è´¥";
            });
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // ç»‘å®šç™»å½•è¡¨å•æäº¤äº‹ä»¶
        document.getElementById('loginForm').addEventListener('submit', handleLogin);

        // ç»‘å®šæ³¨å†Œè¡¨å•æäº¤äº‹ä»¶
        document.getElementById('registerForm').addEventListener('submit', handleRegister);

        // ç»‘å®šç™»å½•/æ³¨å†Œåˆ‡æ¢äº‹ä»¶
        document.getElementById('showRegister').addEventListener('click', showRegister);
        document.getElementById('showLogin').addEventListener('click', showLogin);

        // å¯†ç å¼ºåº¦æ£€æµ‹
        document.getElementById('regPassword').addEventListener('input', function() {
            updatePasswordStrength(this.value);
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œè‡ªåŠ¨ç™»å½•
        checkAuthStatus();
    });

    // æ¯30ç§’åˆ·æ–°åª’ä½“
    setInterval(loadFixedMedia, 80000);

    // æ¯5åˆ†é’Ÿåˆ·æ–°è®¿é—®ç»Ÿè®¡æ•°æ®
    setInterval(refreshAccessStats, 5 * 60 * 1000);
</script>
</body>
</html>